<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NILM V4 数据采集计划管理系统 - Schneider Electric</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --se-green-primary: #3DCD58;
            --se-green-dark: #2BA642;
            --se-green-light: #5FD977;
            --se-blue-primary: #0084C7;
            --se-blue-dark: #006699;
            --se-blue-light: #00A3E0;
            --se-gray-50: #F8F9FA;
            --se-gray-100: #E8EAED;
            --se-gray-200: #DADCE0;
            --se-gray-300: #BDC1C6;
            --se-gray-400: #9AA0A6;
            --se-gray-500: #5F6368;
            --se-gray-600: #3C4043;
            --se-gray-700: #202124;
            --se-orange: #FF6600;
            --se-red: #D93025;
            --se-yellow: #FFA500;
            --se-purple: #9C27B0;
        }

        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 50%, #f0f8ff 100%);
            color: var(--se-gray-700);
            min-height: 100vh;
        }

        /* Schneider Electric Styling - 保持与原网页一致 */
        .se-header {
            background: linear-gradient(90deg, var(--se-green-primary) 0%, var(--se-blue-primary) 100%);
            box-shadow: 0 8px 32px rgba(61, 205, 88, 0.2);
        }

        .se-logo {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .se-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(61, 205, 88, 0.15);
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.06),
                0 4px 16px rgba(61, 205, 88, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .se-card:hover {
            border-color: rgba(61, 205, 88, 0.3);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.08),
                0 8px 24px rgba(61, 205, 88, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .se-card-title {
            color: var(--se-gray-700);
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .se-card-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, var(--se-green-primary), var(--se-blue-primary));
            border-radius: 2px;
        }

        /* 按钮样式 */
        .se-btn-primary {
            background: linear-gradient(135deg, var(--se-green-primary), var(--se-green-light));
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(61, 205, 88, 0.25);
            cursor: pointer;
        }

        .se-btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--se-green-dark), var(--se-green-primary));
            box-shadow: 0 6px 20px rgba(61, 205, 88, 0.35);
            transform: translateY(-1px);
        }

        .se-btn-secondary {
            background: linear-gradient(135deg, var(--se-blue-primary), var(--se-blue-light));
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 132, 199, 0.25);
            cursor: pointer;
        }

        .se-btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--se-blue-dark), var(--se-blue-primary));
            box-shadow: 0 6px 20px rgba(0, 132, 199, 0.35);
            transform: translateY(-1px);
        }

        .se-btn-danger {
            background: linear-gradient(135deg, var(--se-red), #ff4444);
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(217, 48, 37, 0.25);
            cursor: pointer;
        }

        .se-btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #c42717, var(--se-red));
            box-shadow: 0 6px 20px rgba(217, 48, 37, 0.35);
            transform: translateY(-1px);
        }

        .se-btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .se-btn-primary:disabled,
        .se-btn-secondary:disabled,
        .se-btn-danger:disabled {
            background: linear-gradient(135deg, var(--se-gray-300), var(--se-gray-400));
            box-shadow: 0 2px 8px rgba(189, 193, 198, 0.2);
            transform: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* 状态标签 */
        .se-status-connected {
            background: linear-gradient(135deg, var(--se-green-primary), var(--se-green-light));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(61, 205, 88, 0.3);
        }

        .se-status-waiting {
            background: linear-gradient(135deg, var(--se-orange), var(--se-yellow));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(255, 102, 0, 0.3);
        }

        .se-status-completed {
            background: linear-gradient(135deg, var(--se-blue-primary), var(--se-blue-light));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 132, 199, 0.3);
        }

        .se-status-inactive {
            background: linear-gradient(135deg, var(--se-gray-400), var(--se-gray-500));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(95, 99, 104, 0.3);
        }

        /* 输入框样式 */
        .se-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(61, 205, 88, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            color: var(--se-gray-700);
            transition: all 0.3s ease;
            width: 100%;
        }

        .se-input:focus {
            outline: none;
            border-color: var(--se-green-primary);
            box-shadow: 0 0 0 3px rgba(61, 205, 88, 0.1);
        }

        .se-select {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(61, 205, 88, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            color: var(--se-gray-700);
            transition: all 0.3s ease;
            width: 100%;
        }

        .se-select:focus {
            outline: none;
            border-color: var(--se-green-primary);
            box-shadow: 0 0 0 3px rgba(61, 205, 88, 0.1);
        }

        /* 测试项目列表 */
        .test-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(61, 205, 88, 0.2);
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            margin-bottom: 0.5rem;
        }

        .test-item:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(61, 205, 88, 0.4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .test-item.current {
            background: rgba(61, 205, 88, 0.1);
            border-color: var(--se-green-primary);
            box-shadow: 0 4px 16px rgba(61, 205, 88, 0.2);
        }

        .test-item.completed {
            background: rgba(0, 132, 199, 0.1);
            border-color: var(--se-blue-primary);
            opacity: 0.8;
        }

        /* 模态框 */
        .se-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(61, 205, 88, 0.2);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        /* 进度条 */
        .progress-bar {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(61, 205, 88, 0.2);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--se-green-primary), var(--se-blue-primary));
            height: 100%;
            transition: width 0.3s ease;
        }

        /* 日志面板 */
        .se-log-panel {
            font-family: 'Fira Code', 'Courier New', Courier, monospace;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(61, 205, 88, 0.15);
            color: var(--se-gray-600);
            padding: 1rem;
            border-radius: 12px;
            height: 200px;
            overflow-y: auto;
            font-size: 0.875rem;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .se-log-entry {
            white-space: pre-wrap;
            word-break: break-all;
            padding: 2px 0;
        }

        .se-log-entry.error { color: var(--se-red); font-weight: 500; }
        .se-log-entry.success { color: var(--se-green-dark); font-weight: 500; }
        .se-log-entry.info { color: var(--se-blue-primary); font-weight: 500; }
        .se-log-entry.warning { color: var(--se-orange); font-weight: 500; }

        /* 图表容器 */
        .se-chart-container {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(61, 205, 88, 0.15);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        /* 滚动条 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { 
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, var(--se-green-primary), var(--se-blue-primary));
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, var(--se-green-light), var(--se-blue-light));
        }

        /* 响应式调整 */
        @media (max-width: 1024px) {
            .se-card {
                padding: 1rem;
            }
        }

        /* 背景图案 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(61, 205, 88, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(0, 132, 199, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* 事件类型标签 */
        .event-type-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0.125rem;
        }

        .event-type-tag.on { background: rgba(61, 205, 88, 0.2); color: var(--se-green-dark); }
        .event-type-tag.off { background: rgba(217, 48, 37, 0.2); color: var(--se-red); }
        .event-type-tag.multi { background: rgba(0, 132, 199, 0.2); color: var(--se-blue-dark); }
        .event-type-tag.special { background: rgba(156, 39, 176, 0.2); color: var(--se-purple); }
    </style>
</head>
<body class="antialiased p-4 lg:p-6">

    <div class="max-w-screen-2xl mx-auto">
        <!-- Schneider Electric Header -->
        <header class="se-header mb-8 p-6 rounded-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="se-logo">SCHNEIDER ELECTRIC</div>
                    <div class="h-8 w-px bg-white opacity-30"></div>
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold text-white">NILM V4 数据采集计划管理系统</h1>
                        <p class="text-white/80 mt-1">高精度电器识别项目 - 自动化测试计划执行</p>
                    </div>
                </div>
                <div class="hidden lg:flex items-center gap-4">
                    <div class="text-white/60 text-sm">EcoStruxure™ NILM Platform</div>
                    <div class="h-12 w-12 bg-white/10 rounded-lg flex items-center justify-center">
                        <div class="w-6 h-6 bg-white rounded-sm"></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">

            <!-- 左侧控制面板 -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                
                <!-- 系统状态 -->
                <div class="se-card">
                    <h2 class="se-card-title">系统状态</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">设备连接</span>
                            <span id="device-status" class="px-3 py-1 rounded-full text-sm se-status-inactive">未连接</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">采集模式</span>
                            <span id="collection-mode" class="px-3 py-1 rounded-full text-sm se-status-inactive">触发模式</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">队列状态</span>
                            <span id="queue-status" class="px-3 py-1 rounded-full text-sm se-status-inactive">空闲</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-secondary">测试进度</span>
                            <span id="test-progress" class="font-mono text-sm text-gray-700">0 / 0</span>
                        </div>
                        <div class="progress-bar mt-2">
                            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- 全局控制 -->
                <div class="se-card">
                    <h2 class="se-card-title">全局控制</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-start-system" class="se-btn-primary">启动系统</button>
                        <button id="btn-stop-system" class="se-btn-danger">停止系统</button>
                        <button id="btn-start-queue" class="se-btn-secondary" disabled>开始队列</button>
                        <button id="btn-pause-queue" class="se-btn-secondary" disabled>暂停队列</button>
                        <button id="btn-create-plan" class="se-btn-primary col-span-2">创建测试计划</button>
                        <button id="btn-import-plan" class="se-btn-secondary col-span-2">导入计划配置</button>
                    </div>
                </div>

                <!-- 全局设置 -->
                <div class="se-card">
                    <h2 class="se-card-title">全局设置</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2">默认保存格式</label>
                            <select id="default-format" class="se-select">
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                                <option value="binary">Binary</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2">根目录</label>
                            <input type="text" id="root-directory" class="se-input" value="NILM_Dataset_V4" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2">数据集阶段</label>
                            <select id="dataset-phase" class="se-select">
                                <option value="phase_1_independent">阶段一：独立设备测试</option>
                                <option value="phase_2_combined">阶段二：组合场景测试</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 日志输出 -->
                <div class="se-card flex-grow flex flex-col">
                    <h2 class="se-card-title">日志输出</h2>
                    <div id="log-panel" class="se-log-panel flex-grow"></div>
                </div>
            </div>

            <!-- 右侧主要区域 -->
            <div class="lg:col-span-3 flex flex-col gap-6">
                
                <!-- 测试队列 -->
                <div class="se-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="se-card-title mb-0">测试队列</h2>
                        <div class="flex gap-2">
                            <button id="btn-clear-queue" class="se-btn-danger se-btn-small">清空队列</button>
                            <button id="btn-export-results" class="se-btn-secondary se-btn-small" disabled>导出结果</button>
                        </div>
                    </div>
                    <div id="test-queue" class="h-64 overflow-y-auto space-y-2 pr-2">
                        <div class="text-center text-gray-500 mt-8">
                            <p>暂无测试计划</p>
                            <p class="text-sm mt-2">点击"创建测试计划"开始配置</p>
                        </div>
                    </div>
                </div>

                <!-- 当前测试详情 -->
                <div class="se-card">
                    <h2 class="se-card-title">当前测试详情</h2>
                    <div id="current-test-info" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <p>暂无执行中的测试</p>
                        </div>
                    </div>
                </div>

                <!-- 实时波形预览 -->
                <div class="se-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="se-card-title mb-0">实时波形预览</h2>
                        <div class="flex items-center gap-2">
                            <span id="ws-status-dot" class="w-3 h-3 rounded-full bg-red-500"></span>
                            <span id="ws-status-text" class="text-sm text-secondary">未连接</span>
                        </div>
                    </div>
                    <div class="se-chart-container">
                        <div id="realtimeChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 创建测试计划模态框 -->
    <div id="create-plan-modal" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="se-modal-content p-6 w-full max-w-4xl m-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">创建测试计划</h3>
            
            <!-- 计划基本信息 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-secondary mb-2">计划名称</label>
                    <input type="text" id="plan-name" class="se-input" placeholder="如：客厅设备测试">
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary mb-2">设备分类</label>
                    <select id="device-category" class="se-select">
                        <option value="">选择设备分类</option>
                        <option value="1_resistive">1. 纯阻性负载</option>
                        <option value="2_inductive">2. 感性负载</option>
                        <option value="3_smps">3. 开关电源负载</option>
                        <option value="4_mixed_complex">4. 混合复杂负载</option>
                        <option value="5_electronic_control">5. 电子控制负载</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary mb-2">默认采集次数</label>
                    <input type="number" id="default-count" class="se-input" value="3" min="1" max="10">
                </div>
            </div>

            <!-- 设备选择器 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3">设备配置</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">设备信息</label>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="text" id="device-name" class="se-input" placeholder="设备名">
                            <input type="text" id="device-brand" class="se-input" placeholder="品牌">
                            <input type="text" id="device-power" class="se-input" placeholder="功率">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">事件类型</label>
                        <div class="flex flex-wrap gap-1" id="event-types-container">
                            <!-- 事件类型选择器将在这里动态生成 -->
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <button id="btn-add-device" class="se-btn-primary se-btn-small">添加设备配置</button>
                    <div class="text-sm text-gray-500">
                        <span id="device-count">0</span> 个设备，总计 <span id="total-tests">0</span> 个测试项
                    </div>
                </div>
            </div>

            <!-- 设备列表预览 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3">已配置设备</h4>
                <div id="configured-devices" class="max-h-64 overflow-y-auto space-y-2">
                    <div class="text-center text-gray-500 py-4">
                        <p>暂无配置设备</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="btn-cancel-plan" class="se-btn-secondary">取消</button>
                <button id="btn-save-plan" class="se-btn-primary" disabled>保存计划</button>
            </div>
        </div>
    </div>

    <!-- 事件确认模态框 -->
    <div id="event-confirm-modal" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="se-modal-content p-6 w-full max-w-md m-4">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">确认触发事件</h3>
            <div class="text-center mb-6">
                <div class="text-lg font-medium text-green-600 mb-2">检测到设备触发</div>
                <div id="trigger-device-info" class="text-gray-600">
                    <p>设备：<span id="trigger-device-name">-</span></p>
                    <p>预设事件：<span id="trigger-preset-event">-</span></p>
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-secondary mb-2">确认事件类型</label>
                <select id="confirm-event-type" class="se-select">
                    <!-- 动态填充事件类型选项 -->
                </select>
            </div>
            <div class="flex justify-end gap-3">
                <button id="btn-cancel-trigger" class="se-btn-secondary">取消</button>
                <button id="btn-confirm-trigger" class="se-btn-primary">确认并保存</button>
            </div>
        </div>
    </div>

    <!-- 导入配置模态框 -->
    <div id="import-plan-modal" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="se-modal-content p-6 w-full max-w-2xl m-4">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">导入测试计划配置</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-secondary mb-2">选择配置文件 (JSON格式)</label>
                <input type="file" id="config-file-input" accept=".json" class="se-input">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-secondary mb-2">或粘贴JSON配置</label>
                <textarea id="config-text-input" class="se-input h-32" placeholder="粘贴JSON配置内容..."></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button id="btn-cancel-import" class="se-btn-secondary">取消</button>
                <button id="btn-confirm-import" class="se-btn-primary">导入</button>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const API_BASE_URL = 'http://127.0.0.1:8080';
    const WS_URL = 'ws://127.0.0.1:8081';
    const STATUS_POLL_INTERVAL = 2000;
    
    let ws;
    let realtimeChart;
    let testQueue = [];
    let currentTestIndex = -1;
    let isSystemRunning = false;
    let isQueueRunning = false;
    let pendingTrigger = null;

    // V4 规范的设备分类和事件类型定义
    const DEVICE_CATEGORIES = {
        '1_resistive': {
            name: '纯阻性负载',
            devices: ['halogen_lamp', 'thermal_lamp', 'roaster_oven', 'electric_iron', 'water_heater'],
            events: ['on', 'off']
        },
        '2_inductive': {
            name: '感性负载',
            subcategories: {
                '2a_ac_induction_motor': {
                    name: 'AC感应电机',
                    devices: ['refrigerator', 'air_conditioner_fixed', 'fan', 'automated_curtains'],
                    events: ['on', 'off', 'low_on', 'mid_on', 'high_on']
                },
                '2b_universal_motor': {
                    name: '串激电机',
                    devices: ['vacuum_cleaner', 'juicer', 'hair_dryer'],
                    events: ['on', 'off', 'cold_on', 'hot_on']
                }
            }
        },
        '3_smps': {
            name: '开关电源负载',
            subcategories: {
                '3a_smps_no_pfc': {
                    name: '无PFC开关电源',
                    devices: ['led_lamp', 'led_band', 'router'],
                    events: ['on', 'off']
                },
                '3b_smps_pfc': {
                    name: '带PFC开关电源',
                    devices: ['computer_smps_lcd', 'server', 'tv', 'printer'],
                    events: ['on', 'off', 'print_on', 'heat_on']
                },
                '3c_smps_special_ballast': {
                    name: '特殊镇流器',
                    devices: ['t5_lamp'],
                    events: ['on', 'off']
                }
            }
        },
        '4_mixed_complex': {
            name: '混合复杂负载',
            devices: ['microwave_oven', 'washing_machine', 'bath_heater', 'kitchen_ventilator', 'air_conditioner_inverter'],
            events: ['on', 'off', 'wash_on', 'spin_on', 'heatwash_on', 'light_on', 'fan_on', 'heat_on', 'all_on']
        },
        '5_electronic_control': {
            name: '电子控制负载',
            devices: ['dimmer', 'electromagnetic_oven'],
            events: ['on', 'off', 'dim25_on', 'dim50_on', 'dim75_on', 'dim100_on']
        }
    };

    // DOM 元素引用
    const elements = {
        deviceStatus: document.getElementById('device-status'),
        collectionMode: document.getElementById('collection-mode'),
        queueStatus: document.getElementById('queue-status'),
        testProgress: document.getElementById('test-progress'),
        progressFill: document.getElementById('progress-fill'),
        logPanel: document.getElementById('log-panel'),
        testQueue: document.getElementById('test-queue'),
        currentTestInfo: document.getElementById('current-test-info'),
        wsStatusDot: document.getElementById('ws-status-dot'),
        wsStatusText: document.getElementById('ws-status-text'),
        
        // 按钮
        btnStartSystem: document.getElementById('btn-start-system'),
        btnStopSystem: document.getElementById('btn-stop-system'),
        btnStartQueue: document.getElementById('btn-start-queue'),
        btnPauseQueue: document.getElementById('btn-pause-queue'),
        btnCreatePlan: document.getElementById('btn-create-plan'),
        btnImportPlan: document.getElementById('btn-import-plan'),
        btnClearQueue: document.getElementById('btn-clear-queue'),
        
        // 设置
        defaultFormat: document.getElementById('default-format'),
        rootDirectory: document.getElementById('root-directory'),
        datasetPhase: document.getElementById('dataset-phase'),
        
        // 模态框
        createPlanModal: document.getElementById('create-plan-modal'),
        eventConfirmModal: document.getElementById('event-confirm-modal'),
        importPlanModal: document.getElementById('import-plan-modal')
    };

    // 日志功能
    function log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.classList.add('se-log-entry', type);
        const timestamp = new Date().toLocaleTimeString('en-GB');
        entry.textContent = `[${timestamp}] ${message}`;
        elements.logPanel.appendChild(entry);
        elements.logPanel.scrollTop = elements.logPanel.scrollHeight;
    }

    // API 请求函数
    async function apiRequest(endpoint, method = 'GET', body = null) {
        const url = API_BASE_URL + endpoint;
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        if (body) options.body = JSON.stringify(body);
        
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const data = await response.json();
                if (data.success) {
                    if (endpoint !== '/api/control/status') {
                        log(`API ${method} ${endpoint}: ${typeof data.data === 'string' ? data.data : 'Success'}`, 'success');
                    }
                } else {
                    log(`API ${method} ${endpoint} FAILED: ${data.error}`, 'error');
                }
                return data;
            } else {
                return { success: true, data: 'Non-JSON response received.' };
            }
        } catch (error) {
            log(`API Request Error: ${error.message}`, 'error');
            return null;
        }
    }

    // WebSocket 连接
    function connectWebSocket() {
        ws = new WebSocket(WS_URL);
        
        ws.onopen = () => {
            log('WebSocket connection established', 'success');
            elements.wsStatusDot.className = 'w-3 h-3 rounded-full bg-green-500';
            elements.wsStatusText.textContent = '已连接';
            ws.send(JSON.stringify({ type: 'subscribe', channels: ['all'] }));
        };
        
        ws.onmessage = event => {
            const msg = JSON.parse(event.data);
            handleWebSocketMessage(msg);
        };
        
        ws.onclose = () => {
            log('WebSocket closed. Reconnecting in 5s...', 'error');
            elements.wsStatusDot.className = 'w-3 h-3 rounded-full bg-red-500';
            elements.wsStatusText.textContent = '已断开';
            setTimeout(connectWebSocket, 5000);
        };
        
        ws.onerror = () => {
            log('WebSocket error', 'error');
            ws.close();
        };
    }

    // 处理WebSocket消息
    function handleWebSocketMessage(msg) {
        if (msg.type === 'data' && msg.data && msg.channel_count > 0) {
            updateRealtimeChart(msg);
        } else if (msg.type === 'trigger_burst_complete') {
            log(`Trigger burst complete: ${msg.burst_id}`, 'info');
            if (isQueueRunning && currentTestIndex >= 0) {
                handleTriggerEvent(msg.burst_id);
            }
        }
    }

    // 处理触发事件
    function handleTriggerEvent(burstId) {
        if (currentTestIndex < 0 || currentTestIndex >= testQueue.length) return;
        
        const currentTest = testQueue[currentTestIndex];
        pendingTrigger = { burstId, test: currentTest };
        
        // 显示事件确认对话框
        showEventConfirmModal(currentTest);
    }

    // 显示事件确认模态框
    function showEventConfirmModal(test) {
        document.getElementById('trigger-device-name').textContent = test.deviceFullName;
        document.getElementById('trigger-preset-event').textContent = test.eventType;
        
        const eventSelect = document.getElementById('confirm-event-type');
        eventSelect.innerHTML = '';
        
        // 根据设备类型填充可用事件类型
        const availableEvents = getAvailableEvents(test.category, test.subcategory);
        availableEvents.forEach(event => {
            const option = document.createElement('option');
            option.value = event;
            option.textContent = event;
            option.selected = event === test.eventType;
            eventSelect.appendChild(option);
        });
        
        elements.eventConfirmModal.classList.remove('hidden');
    }

    // 获取可用事件类型
    function getAvailableEvents(category, subcategory = null) {
        if (subcategory && DEVICE_CATEGORIES[category]?.subcategories?.[subcategory]) {
            return DEVICE_CATEGORIES[category].subcategories[subcategory].events;
        } else if (DEVICE_CATEGORIES[category]?.events) {
            return DEVICE_CATEGORIES[category].events;
        }
        return ['on', 'off']; // 默认事件类型
    }

    // 确认触发事件并保存
    async function confirmTriggerAndSave() {
        if (!pendingTrigger) return;
        
        const confirmedEventType = document.getElementById('confirm-event-type').value;
        const test = pendingTrigger.test;
        
        // 生成V4规范文件名（不含扩展名）
        const filename = generateV4Filename(test, confirmedEventType);
        const savePath = generateV4SavePath(test);
        
        // 调用保存API - 匹配测试脚本中的数据结构
        const saveData = {
            dir: savePath,
            filename: filename,
            format: elements.defaultFormat.value,
            description: `NILM V4 - ${test.planName} - ${test.deviceFullName} - ${confirmedEventType}`
        };
        
        log(`正在保存触发数据: ${filename}.${elements.defaultFormat.value}`, 'info');
        const result = await apiRequest(`/api/trigger/save/${pendingTrigger.burstId}`, 'POST', saveData);
        
        if (result && result.success) {
            const savedPath = result.data?.saved_path || `${savePath}/${filename}.${elements.defaultFormat.value}`;
            log(`文件保存成功: ${savedPath}`, 'success');
            
            // 更新测试状态
            test.completedRuns++;
            test.status = test.completedRuns >= test.totalRuns ? 'completed' : 'running';
            
            updateTestQueue();
            updateCurrentTestInfo();
            updateProgress();
            
            // 如果当前测试完成，移到下一个
            if (test.status === 'completed') {
                moveToNextTest();
            }
        } else {
            log(`保存失败: ${result ? result.error : 'Unknown error'}`, 'error');
        }
        
        // 清理待处理触发
        pendingTrigger = null;
        elements.eventConfirmModal.classList.add('hidden');
    }

    // 生成V4规范文件名
    function generateV4Filename(test, eventType) {
        const runNumber = String(test.completedRuns + 1).padStart(3, '0');
        return `${test.deviceFullName}_${eventType}_${runNumber}`;
    }

    // 生成V4规范保存路径
    function generateV4SavePath(test) {
        const phase = elements.datasetPhase.value;
        let path = `${elements.rootDirectory.value}/${phase}`;
        
        if (phase === 'phase_1_independent') {
            path += `/${test.category}`;
            if (test.subcategory) {
                path += `/${test.subcategory}`;
            }
            path += `/${test.deviceFullName}`;
        } else {
            // phase_2_combined 的路径处理
            path += `/${test.scenarioType}/${test.scenarioName}`;
        }
        
        return path;
    }

    // 移动到下一个测试
    function moveToNextTest() {
        if (currentTestIndex + 1 < testQueue.length) {
            currentTestIndex++;
            const nextTest = testQueue[currentTestIndex];
            nextTest.status = 'running';
            log(`开始执行测试: ${nextTest.deviceFullName} - ${nextTest.eventType}`, 'info');
        } else {
            // 队列完成
            isQueueRunning = false;
            currentTestIndex = -1;
            log('所有测试已完成!', 'success');
            updateQueueControls();
        }
        
        updateTestQueue();
        updateCurrentTestInfo();
        updateProgress();
    }

    // 更新测试队列显示
    function updateTestQueue() {
        const container = elements.testQueue;
        container.innerHTML = '';
        
        if (testQueue.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 mt-8">
                    <p>暂无测试计划</p>
                    <p class="text-sm mt-2">点击"创建测试计划"开始配置</p>
                </div>
            `;
            return;
        }
        
        testQueue.forEach((test, index) => {
            const testItem = document.createElement('div');
            testItem.className = `test-item ${index === currentTestIndex ? 'current' : ''} ${test.status === 'completed' ? 'completed' : ''}`;
            
            testItem.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-grow">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold text-gray-700">${test.deviceFullName}</span>
                            <span class="event-type-tag ${getEventTypeClass(test.eventType)}">${test.eventType}</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>计划: ${test.planName}</p>
                            <p>分类: ${test.categoryName}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="px-3 py-1 rounded-full text-sm ${getStatusClass(test.status)}">${getStatusText(test.status)}</div>
                        <div class="text-xs text-gray-500 mt-1">${test.completedRuns} / ${test.totalRuns}</div>
                    </div>
                </div>
            `;
            
            container.appendChild(testItem);
        });
    }

    // 更新当前测试信息
    function updateCurrentTestInfo() {
        const container = elements.currentTestInfo;
        
        if (currentTestIndex < 0 || currentTestIndex >= testQueue.length) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p>暂无执行中的测试</p>
                </div>
            `;
            return;
        }
        
        const test = testQueue[currentTestIndex];
        container.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">设备信息</h4>
                    <p><strong>设备:</strong> ${test.deviceFullName}</p>
                    <p><strong>事件类型:</strong> ${test.eventType}</p>
                    <p><strong>当前进度:</strong> ${test.completedRuns} / ${test.totalRuns}</p>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">文件信息</h4>
                    <p><strong>保存路径:</strong> ${generateV4SavePath(test)}</p>
                    <p><strong>文件前缀:</strong> ${test.deviceFullName}_${test.eventType}_xxx</p>
                    <p><strong>保存格式:</strong> ${elements.defaultFormat.value.toUpperCase()}</p>
                </div>
            </div>
            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-yellow-800 text-center">
                    <strong>等待设备触发...</strong> 请执行设备操作以触发数据采集
                </p>
            </div>
        `;
    }

    // 更新进度
    function updateProgress() {
        let completed = 0;
        let total = 0;
        
        testQueue.forEach(test => {
            total += test.totalRuns;
            completed += test.completedRuns;
        });
        
        elements.testProgress.textContent = `${completed} / ${total}`;
        const percentage = total > 0 ? (completed / total) * 100 : 0;
        elements.progressFill.style.width = `${percentage}%`;
    }

    // 获取状态样式类
    function getStatusClass(status) {
        switch (status) {
            case 'waiting': return 'se-status-inactive';
            case 'running': return 'se-status-waiting';
            case 'completed': return 'se-status-completed';
            default: return 'se-status-inactive';
        }
    }

    // 获取状态文本
    function getStatusText(status) {
        switch (status) {
            case 'waiting': return '等待';
            case 'running': return '执行中';
            case 'completed': return '已完成';
            default: return '未知';
        }
    }

    // 获取事件类型样式类
    function getEventTypeClass(eventType) {
        if (eventType.includes('on') && !eventType.includes('off')) {
            if (eventType.includes('low') || eventType.includes('mid') || eventType.includes('high') || 
                eventType.includes('cold') || eventType.includes('hot') || eventType.includes('dim')) {
                return 'multi';
            }
            return 'on';
        } else if (eventType.includes('off')) {
            return 'off';
        }
        return 'special';
    }

    // 初始化实时图表
    function initRealtimeChart() {
        realtimeChart = echarts.init(document.getElementById('realtimeChart'));
        const option = {
            backgroundColor: 'transparent',
            tooltip: { trigger: 'axis' },
            grid: { left: 60, right: 20, bottom: 40, top: 20, containLabel: false },
            xAxis: { 
                type: 'category', 
                boundaryGap: false, 
                data: [],
                axisLabel: { color: '#5F6368' }
            },
            yAxis: { 
                type: 'value', 
                axisLabel: { color: '#5F6368' },
                splitLine: { lineStyle: { color: 'rgba(189, 193, 198, 0.3)' } }
            },
            series: []
        };
        realtimeChart.setOption(option);
    }

    // 更新实时图表
    function updateRealtimeChart(msg) {
        if (!realtimeChart || !msg.data || msg.channel_count === 0) return;
        
        const samplesPerChannel = Math.floor(msg.data.length / msg.channel_count);
        const channelData = {};
        
        // 分离通道数据
        for (let ch = 0; ch < msg.channel_count; ch++) {
            channelData[ch] = [];
            for (let s = 0; s < samplesPerChannel; s++) {
                channelData[ch].push(msg.data[ch * samplesPerChannel + s]);
            }
        }
        
        // 更新图表
        const seriesData = Object.keys(channelData).map((ch, i) => ({
            name: `通道 ${ch}`,
            type: 'line',
            data: channelData[ch],
            showSymbol: false,
            lineStyle: { 
                color: ['#3DCD58', '#0084C7', '#FF6600', '#D93025'][i % 4],
                width: 1.5 
            },
            animation: false
        }));
        
        const xAxisData = Array.from({ length: samplesPerChannel }, (_, i) => i);
        
        realtimeChart.setOption({
            xAxis: { data: xAxisData },
            series: seriesData
        });
    }

    // 更新队列控制按钮
    function updateQueueControls() {
        elements.btnStartQueue.disabled = !isSystemRunning || testQueue.length === 0 || isQueueRunning;
        elements.btnPauseQueue.disabled = !isQueueRunning;
        
        if (isQueueRunning) {
            elements.queueStatus.textContent = '执行中';
            elements.queueStatus.className = 'px-3 py-1 rounded-full text-sm se-status-waiting';
        } else if (testQueue.length > 0) {
            elements.queueStatus.textContent = '就绪';
            elements.queueStatus.className = 'px-3 py-1 rounded-full text-sm se-status-connected';
        } else {
            elements.queueStatus.textContent = '空闲';
            elements.queueStatus.className = 'px-3 py-1 rounded-full text-sm se-status-inactive';
        }
    }

    // 系统状态轮询
    async function pollStatus() {
        const result = await apiRequest('/api/control/status');
        if (result && result.success) {
            const status = result.data;
            
            // 更新设备状态
            if (status.device_connected) {
                elements.deviceStatus.textContent = '已连接';
                elements.deviceStatus.className = 'px-3 py-1 rounded-full text-sm se-status-connected';
            } else {
                elements.deviceStatus.textContent = '未连接';
                elements.deviceStatus.className = 'px-3 py-1 rounded-full text-sm se-status-inactive';
            }
            
            // 更新采集模式
            if (status.current_mode === 'trigger') {
                elements.collectionMode.textContent = '触发模式';
                elements.collectionMode.className = 'px-3 py-1 rounded-full text-sm se-status-waiting';
            } else {
                elements.collectionMode.textContent = '连续模式';
                elements.collectionMode.className = 'px-3 py-1 rounded-full text-sm se-status-connected';
            }
            
            // 更新按钮状态
            isSystemRunning = status.data_collection_active;
            elements.btnStartSystem.disabled = isSystemRunning;
            elements.btnStopSystem.disabled = !isSystemRunning;
            
            updateQueueControls();
        }
    }

    // 事件监听器设置
    function setupEventListeners() {
        // 系统控制
        elements.btnStartSystem.addEventListener('click', async () => {
            await apiRequest('/api/control/start', 'POST');
            await apiRequest('/api/control/trigger_mode', 'POST');
        });
        
        elements.btnStopSystem.addEventListener('click', () => {
            apiRequest('/api/control/stop', 'POST');
        });
        
        // 队列控制
        elements.btnStartQueue.addEventListener('click', () => {
            if (testQueue.length > 0) {
                isQueueRunning = true;
                currentTestIndex = 0;
                testQueue[0].status = 'running';
                log('开始执行测试队列', 'info');
                updateTestQueue();
                updateCurrentTestInfo();
                updateQueueControls();
            }
        });
        
        elements.btnPauseQueue.addEventListener('click', () => {
            isQueueRunning = false;
            log('测试队列已暂停', 'warning');
            updateQueueControls();
        });
        
        elements.btnClearQueue.addEventListener('click', () => {
            if (confirm('确定要清空测试队列吗？')) {
                testQueue = [];
                currentTestIndex = -1;
                isQueueRunning = false;
                updateTestQueue();
                updateCurrentTestInfo();
                updateProgress();
                updateQueueControls();
                log('测试队列已清空', 'info');
            }
        });
        
        // 计划管理
        elements.btnCreatePlan.addEventListener('click', () => {
            elements.createPlanModal.classList.remove('hidden');
            initCreatePlanModal();
        });
        
        elements.btnImportPlan.addEventListener('click', () => {
            elements.importPlanModal.classList.remove('hidden');
        });
        
        // 事件确认
        document.getElementById('btn-confirm-trigger').addEventListener('click', confirmTriggerAndSave);
        document.getElementById('btn-cancel-trigger').addEventListener('click', () => {
            pendingTrigger = null;
            elements.eventConfirmModal.classList.add('hidden');
        });
        
        // 模态框关闭
        document.getElementById('btn-cancel-plan').addEventListener('click', () => {
            elements.createPlanModal.classList.add('hidden');
        });
        
        document.getElementById('btn-cancel-import').addEventListener('click', () => {
            elements.importPlanModal.classList.add('hidden');
        });
    }

    // 创建计划模态框初始化
    function initCreatePlanModal() {
        // 设备分类变化时更新事件类型
        const categorySelect = document.getElementById('device-category');
        const eventTypesContainer = document.getElementById('event-types-container');
        
        categorySelect.addEventListener('change', () => {
            updateEventTypesContainer(categorySelect.value);
        });
        
        // 添加设备按钮
        document.getElementById('btn-add-device').addEventListener('click', addDeviceToList);
        
        // 保存计划按钮
        document.getElementById('btn-save-plan').addEventListener('click', savePlan);
        
        // 导入配置按钮
        document.getElementById('btn-confirm-import').addEventListener('click', importConfig);
        
        // 初始化事件类型容器
        updateEventTypesContainer('');
    }

    // 更新事件类型容器
    function updateEventTypesContainer(category) {
        const container = document.getElementById('event-types-container');
        container.innerHTML = '';
        
        if (!category || !DEVICE_CATEGORIES[category]) {
            container.innerHTML = '<p class="text-sm text-gray-500">请先选择设备分类</p>';
            return;
        }
        
        let availableEvents = [];
        
        if (DEVICE_CATEGORIES[category].subcategories) {
            // 如果有子分类，显示所有可能的事件类型
            Object.values(DEVICE_CATEGORIES[category].subcategories).forEach(sub => {
                availableEvents.push(...sub.events);
            });
        } else {
            availableEvents = DEVICE_CATEGORIES[category].events || ['on', 'off'];
        }
        
        // 去重
        availableEvents = [...new Set(availableEvents)];
        
        availableEvents.forEach(event => {
            const checkbox = document.createElement('label');
            checkbox.className = 'inline-flex items-center cursor-pointer';
            checkbox.innerHTML = `
                <input type="checkbox" value="${event}" class="sr-only">
                <span class="event-type-tag ${getEventTypeClass(event)} cursor-pointer border-2 border-transparent hover:border-gray-300">
                    ${event}
                </span>
            `;
            
            const input = checkbox.querySelector('input');
            const span = checkbox.querySelector('span');
            
            input.addEventListener('change', () => {
                if (input.checked) {
                    span.classList.add('ring-2', 'ring-blue-500');
                } else {
                    span.classList.remove('ring-2', 'ring-blue-500');
                }
            });
            
            container.appendChild(checkbox);
        });
    }

    // 添加设备到列表
    function addDeviceToList() {
        const planName = document.getElementById('plan-name').value.trim();
        const category = document.getElementById('device-category').value;
        const deviceName = document.getElementById('device-name').value.trim();
        const deviceBrand = document.getElementById('device-brand').value.trim();
        const devicePower = document.getElementById('device-power').value.trim();
        const defaultCount = parseInt(document.getElementById('default-count').value) || 3;
        
        if (!planName || !category || !deviceName) {
            alert('请填写计划名称、设备分类和设备名称');
            return;
        }
        
        // 获取选中的事件类型
        const selectedEvents = [];
        document.querySelectorAll('#event-types-container input[type="checkbox"]:checked').forEach(input => {
            selectedEvents.push(input.value);
        });
        
        if (selectedEvents.length === 0) {
            alert('请至少选择一个事件类型');
            return;
        }
        
        // 生成设备全名
        const deviceFullName = `${deviceName}_${deviceBrand}_${devicePower}`.replace(/\s+/g, '_').toLowerCase();
        
        // 获取分类信息
        const categoryInfo = DEVICE_CATEGORIES[category];
        let subcategory = null;
        
        // 如果有子分类，需要用户选择或自动推断
        if (categoryInfo.subcategories) {
            // 简化处理：根据设备名称推断子分类
            subcategory = inferSubcategory(category, deviceName);
        }
        
        // 为每个事件类型创建测试项
        selectedEvents.forEach(eventType => {
            const testItem = {
                id: Date.now() + Math.random(),
                planName: planName,
                category: category,
                categoryName: categoryInfo.name,
                subcategory: subcategory,
                deviceName: deviceName,
                deviceBrand: deviceBrand,
                devicePower: devicePower,
                deviceFullName: deviceFullName,
                eventType: eventType,
                totalRuns: defaultCount,
                completedRuns: 0,
                status: 'waiting'
            };
            
            testQueue.push(testItem);
        });
        
        // 清空输入框
        document.getElementById('device-name').value = '';
        document.getElementById('device-brand').value = '';
        document.getElementById('device-power').value = '';
        document.querySelectorAll('#event-types-container input[type="checkbox"]').forEach(input => {
            input.checked = false;
            input.dispatchEvent(new Event('change'));
        });
        
        updateConfiguredDevicesDisplay();
        updateDeviceCount();
        
        log(`已添加设备: ${deviceFullName} (${selectedEvents.length} 个事件类型)`, 'success');
    }

    // 推断子分类
    function inferSubcategory(category, deviceName) {
        if (category !== '2_inductive' && category !== '3_smps') return null;
        
        const deviceLower = deviceName.toLowerCase();
        const categoryInfo = DEVICE_CATEGORIES[category];
        
        for (const [subKey, subInfo] of Object.entries(categoryInfo.subcategories)) {
            if (subInfo.devices.some(device => deviceLower.includes(device) || device.includes(deviceLower))) {
                return subKey;
            }
        }
        
        // 默认返回第一个子分类
        return Object.keys(categoryInfo.subcategories)[0];
    }

    // 更新已配置设备显示
    function updateConfiguredDevicesDisplay() {
        const container = document.getElementById('configured-devices');
        
        if (testQueue.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-4"><p>暂无配置设备</p></div>';
            return;
        }
        
        // 按设备分组
        const deviceGroups = {};
        testQueue.forEach(test => {
            const key = test.deviceFullName;
            if (!deviceGroups[key]) {
                deviceGroups[key] = {
                    device: test,
                    events: []
                };
            }
            deviceGroups[key].events.push(test.eventType);
        });
        
        container.innerHTML = '';
        Object.values(deviceGroups).forEach(group => {
            const deviceDiv = document.createElement('div');
            deviceDiv.className = 'test-item';
            deviceDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-grow">
                        <div class="font-semibold text-gray-700 mb-1">${group.device.deviceFullName}</div>
                        <div class="text-sm text-gray-600 mb-2">
                            <p>分类: ${group.device.categoryName}</p>
                            <p>总计: ${group.events.length} 个事件 × ${group.device.totalRuns} 次 = ${group.events.length * group.device.totalRuns} 个测试</p>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${group.events.map(event => `<span class="event-type-tag ${getEventTypeClass(event)}">${event}</span>`).join('')}
                        </div>
                    </div>
                    <button onclick="removeDeviceFromQueue('${group.device.deviceFullName}')" class="se-btn-danger se-btn-small">删除</button>
                </div>
            `;
            container.appendChild(deviceDiv);
        });
    }

    // 从队列中删除设备
    window.removeDeviceFromQueue = function(deviceFullName) {
        testQueue = testQueue.filter(test => test.deviceFullName !== deviceFullName);
        updateConfiguredDevicesDisplay();
        updateDeviceCount();
        log(`已删除设备: ${deviceFullName}`, 'info');
    };

    // 更新设备计数
    function updateDeviceCount() {
        const deviceNames = new Set(testQueue.map(test => test.deviceFullName));
        const totalTests = testQueue.length;
        
        document.getElementById('device-count').textContent = deviceNames.size;
        document.getElementById('total-tests').textContent = totalTests;
        
        // 更新保存按钮状态
        document.getElementById('btn-save-plan').disabled = testQueue.length === 0;
    }

    // 保存计划
    function savePlan() {
        if (testQueue.length === 0) {
            alert('请至少添加一个测试项');
            return;
        }
        
        const planName = document.getElementById('plan-name').value.trim();
        if (!planName) {
            alert('请输入计划名称');
            return;
        }
        
        // 重新排序队列（按设备和事件类型）
        testQueue.sort((a, b) => {
            if (a.deviceFullName !== b.deviceFullName) {
                return a.deviceFullName.localeCompare(b.deviceFullName);
            }
            return a.eventType.localeCompare(b.eventType);
        });
        
        elements.createPlanModal.classList.add('hidden');
        updateTestQueue();
        updateProgress();
        updateQueueControls();
        
        log(`测试计划已创建: ${planName}, 总计 ${testQueue.length} 个测试项`, 'success');
    }

    // 导入配置
    function importConfig() {
        const fileInput = document.getElementById('config-file-input');
        const textInput = document.getElementById('config-text-input');
        
        let configText = textInput.value.trim();
        
        if (!configText && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    processImportedConfig(config);
                } catch (error) {
                    alert('JSON格式错误: ' + error.message);
                }
            };
            reader.readAsText(file);
            return;
        }
        
        if (configText) {
            try {
                const config = JSON.parse(configText);
                processImportedConfig(config);
            } catch (error) {
                alert('JSON格式错误: ' + error.message);
            }
        } else {
            alert('请选择文件或粘贴配置内容');
        }
    }

    // 处理导入的配置
    function processImportedConfig(config) {
        if (!config.testPlans || !Array.isArray(config.testPlans)) {
            alert('配置格式错误：缺少testPlans数组');
            return;
        }
        
        testQueue = [];
        
        config.testPlans.forEach(plan => {
            if (plan.devices && Array.isArray(plan.devices)) {
                plan.devices.forEach(device => {
                    if (device.events && Array.isArray(device.events)) {
                        device.events.forEach(eventType => {
                            const testItem = {
                                id: Date.now() + Math.random(),
                                planName: plan.name || 'Imported Plan',
                                category: device.category,
                                categoryName: DEVICE_CATEGORIES[device.category]?.name || 'Unknown',
                                subcategory: device.subcategory || null,
                                deviceName: device.name,
                                deviceBrand: device.brand,
                                devicePower: device.power,
                                deviceFullName: device.fullName || `${device.name}_${device.brand}_${device.power}`,
                                eventType: eventType,
                                totalRuns: device.runs || 3,
                                completedRuns: 0,
                                status: 'waiting'
                            };
                            testQueue.push(testItem);
                        });
                    }
                });
            }
        });
        
        elements.importPlanModal.classList.add('hidden');
        updateTestQueue();
        updateProgress();
        updateQueueControls();
        
        log(`已导入 ${testQueue.length} 个测试项`, 'success');
    }

    // 导出测试结果
    function exportResults() {
        const results = {
            exportTime: new Date().toISOString(),
            testQueue: testQueue.map(test => ({
                ...test,
                completionRate: (test.completedRuns / test.totalRuns * 100).toFixed(1) + '%'
            })),
            summary: {
                totalTests: testQueue.length,
                completedTests: testQueue.filter(test => test.status === 'completed').length,
                totalRuns: testQueue.reduce((sum, test) => sum + test.totalRuns, 0),
                completedRuns: testQueue.reduce((sum, test) => sum + test.completedRuns, 0)
            }
        };
        
        const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nilm_v4_test_results_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        log('测试结果已导出', 'success');
    }

    // 初始化函数
    function init() {
        log('NILM V4 数据采集计划管理系统启动中...', 'info');
        
        initRealtimeChart();
        setupEventListeners();
        connectWebSocket();
        
        // 开始状态轮询
        pollStatus();
        setInterval(pollStatus, STATUS_POLL_INTERVAL);
        
        updateTestQueue();
        updateProgress();
        updateQueueControls();
        
        log('系统初始化完成', 'success');
    }

    // 启动系统
    init();
});
    </script>

</body>
</html>
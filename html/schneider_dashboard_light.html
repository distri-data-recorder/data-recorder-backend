<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据采集控制面板 - Schneider Electric</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --se-green-primary: #3DCD58;
            --se-green-dark: #2BA642;
            --se-green-light: #5FD977;
            --se-blue-primary: #0084C7;
            --se-blue-dark: #006699;
            --se-blue-light: #00A3E0;
            --se-gray-50: #F8F9FA;
            --se-gray-100: #E8EAED;
            --se-gray-200: #DADCE0;
            --se-gray-300: #BDC1C6;
            --se-gray-400: #9AA0A6;
            --se-gray-500: #5F6368;
            --se-gray-600: #3C4043;
            --se-gray-700: #202124;
            --se-orange: #FF6600;
            --se-red: #D93025;
            --se-yellow: #FFA500;
        }

        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 50%, #f0f8ff 100%);
            color: var(--se-gray-700);
            min-height: 100vh;
        }

        /* Schneider Electric Header */
        .se-header {
            background: linear-gradient(90deg, var(--se-green-primary) 0%, var(--se-blue-primary) 100%);
            box-shadow: 0 8px 32px rgba(61, 205, 88, 0.2);
        }

        .se-logo {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Schneider Electric Cards */
        .se-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(61, 205, 88, 0.15);
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.06),
                0 4px 16px rgba(61, 205, 88, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .se-card:hover {
            border-color: rgba(61, 205, 88, 0.3);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.08),
                0 8px 24px rgba(61, 205, 88, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .se-card-title {
            color: var(--se-gray-700);
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .se-card-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, var(--se-green-primary), var(--se-blue-primary));
            border-radius: 2px;
        }

        /* Status Pills */
        .se-status-connected {
            background: linear-gradient(135deg, var(--se-green-primary), var(--se-green-light));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(61, 205, 88, 0.3);
        }

        .se-status-disconnected {
            background: linear-gradient(135deg, var(--se-red), #ff4444);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(217, 48, 37, 0.3);
        }

        .se-status-active {
            background: linear-gradient(135deg, var(--se-blue-primary), var(--se-blue-light));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 132, 199, 0.3);
        }

        .se-status-inactive {
            background: linear-gradient(135deg, var(--se-gray-400), var(--se-gray-500));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(95, 99, 104, 0.3);
        }

        .se-status-trigger {
            background: linear-gradient(135deg, var(--se-orange), var(--se-yellow));
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(255, 102, 0, 0.3);
        }

        /* Buttons */
        .se-btn-primary {
            background: linear-gradient(135deg, var(--se-green-primary), var(--se-green-light));
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(61, 205, 88, 0.25);
        }

        .se-btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--se-green-dark), var(--se-green-primary));
            box-shadow: 0 6px 20px rgba(61, 205, 88, 0.35);
            transform: translateY(-1px);
        }

        .se-btn-secondary {
            background: linear-gradient(135deg, var(--se-blue-primary), var(--se-blue-light));
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 132, 199, 0.25);
        }

        .se-btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--se-blue-dark), var(--se-blue-primary));
            box-shadow: 0 6px 20px rgba(0, 132, 199, 0.35);
            transform: translateY(-1px);
        }

        .se-btn-danger {
            background: linear-gradient(135deg, var(--se-red), #ff4444);
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(217, 48, 37, 0.25);
        }

        .se-btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #c42717, var(--se-red));
            box-shadow: 0 6px 20px rgba(217, 48, 37, 0.35);
            transform: translateY(-1px);
        }

        .se-btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Button disabled state */
        .se-btn-primary:disabled,
        .se-btn-secondary:disabled,
        .se-btn-danger:disabled {
            background: linear-gradient(135deg, var(--se-gray-300), var(--se-gray-400));
            box-shadow: 0 2px 8px rgba(189, 193, 198, 0.2);
            transform: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Status Dots */
        .se-status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            animation: se-pulse 2s infinite ease-in-out;
            box-shadow: 0 0 12px currentColor;
        }

        @keyframes se-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .se-status-connected-dot {
            background: var(--se-green-primary);
            color: var(--se-green-primary);
        }

        .se-status-disconnected-dot {
            background: var(--se-red);
            color: var(--se-red);
        }

        /* Log Panel */
        .se-log-panel {
            font-family: 'Fira Code', 'Courier New', Courier, monospace;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(61, 205, 88, 0.15);
            color: var(--se-gray-600);
            padding: 1rem;
            border-radius: 12px;
            height: 200px;
            overflow-y: auto;
            font-size: 0.875rem;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .se-log-entry {
            white-space: pre-wrap;
            word-break: break-all;
            padding: 2px 0;
        }

        .se-log-entry.error { color: var(--se-red); font-weight: 500; }
        .se-log-entry.success { color: var(--se-green-dark); font-weight: 500; }
        .se-log-entry.info { color: var(--se-blue-primary); font-weight: 500; }
        .se-log-entry.ws { color: var(--se-orange); font-weight: 500; }

        /* Chart containers */
        .se-chart-container {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(61, 205, 88, 0.15);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        /* File list */
        .se-file-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(61, 205, 88, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .se-file-item:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(61, 205, 88, 0.4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* Trigger list */
        .se-trigger-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(61, 205, 88, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .se-trigger-item:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(61, 205, 88, 0.4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .se-trigger-item.selected {
            background: rgba(61, 205, 88, 0.1);
            border-color: var(--se-green-primary);
            box-shadow: 0 4px 16px rgba(61, 205, 88, 0.2);
        }

        /* Chart mode toggle */
        .se-chart-mode-toggle {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(61, 205, 88, 0.2);
            border-radius: 10px;
            padding: 4px;
            display: flex;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .se-chart-mode-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            color: var(--se-gray-600);
            background: transparent;
        }

        .se-chart-mode-btn.active {
            background: linear-gradient(135deg, var(--se-green-primary), var(--se-green-light));
            color: white;
            box-shadow: 0 2px 8px rgba(61, 205, 88, 0.3);
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { 
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, var(--se-green-primary), var(--se-blue-primary));
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, var(--se-green-light), var(--se-blue-light));
        }

        /* Modal */
        .se-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(61, 205, 88, 0.2);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .se-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(61, 205, 88, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            color: var(--se-gray-700);
            transition: all 0.3s ease;
        }

        .se-input:focus {
            outline: none;
            border-color: var(--se-green-primary);
            box-shadow: 0 0 0 3px rgba(61, 205, 88, 0.1);
        }

        .se-select {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(61, 205, 88, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            color: var(--se-gray-700);
            transition: all 0.3s ease;
        }

        .se-select:focus {
            outline: none;
            border-color: var(--se-green-primary);
            box-shadow: 0 0 0 3px rgba(61, 205, 88, 0.1);
        }

        /* Status indicators */
        .se-status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(61, 205, 88, 0.1);
        }

        .se-status-row:last-child {
            border-bottom: none;
        }

        .se-status-label {
            color: var(--se-gray-600);
            font-weight: 500;
        }

        .se-status-value {
            font-family: 'Fira Code', monospace;
            font-weight: 600;
            color: var(--se-gray-700);
        }

        /* Chart control buttons */
        .se-chart-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .se-chart-control-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(61, 205, 88, 0.2);
            color: var(--se-gray-700);
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .se-chart-control-btn:hover {
            background: rgba(61, 205, 88, 0.1);
            border-color: var(--se-green-primary);
            box-shadow: 0 4px 12px rgba(61, 205, 88, 0.15);
        }

        /* Split view specific styles */
        #realtimeChart.split-view-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #triggerPreviewChart { 
            height: 510px; 
        }

        /* Text colors for light theme */
        .text-accent {
            color: var(--se-green-primary);
        }

        .text-muted {
            color: var(--se-gray-500);
        }

        .text-secondary {
            color: var(--se-gray-600);
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .se-card {
                padding: 1rem;
            }
            
            .se-chart-controls {
                justify-content: center;
            }
        }

        /* Background pattern for added visual interest */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(61, 205, 88, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(0, 132, 199, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
    </style>
</head>
<body class="antialiased p-4 lg:p-6">

    <div class="max-w-screen-2xl mx-auto">
        <!-- Schneider Electric Header -->
        <header class="se-header mb-8 p-6 rounded-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="se-logo">SCHNEIDER ELECTRIC</div>
                    <div class="h-8 w-px bg-white opacity-30"></div>
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold text-white">数据采集系统控制面板</h1>
                        <p class="text-white/80 mt-1">实时监控、控制与数据预览</p>
                    </div>
                </div>
                <div class="hidden lg:flex items-center gap-4">
                    <div class="text-white/60 text-sm">EcoStruxure™ Platform</div>
                    <div class="h-12 w-12 bg-white/10 rounded-lg flex items-center justify-center">
                        <div class="w-6 h-6 bg-white rounded-sm"></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">

            <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- System Status -->
                <div class="se-card">
                    <h2 class="se-card-title">系统状态</h2>
                    <div class="space-y-1">
                        <div class="se-status-row">
                            <span class="se-status-label">设备连接</span>
                            <span id="device-status" class="se-status-value px-3 py-1 rounded-full text-sm">---</span>
                        </div>
                        <div class="se-status-row">
                            <span class="se-status-label">采集状态</span>
                            <span id="collection-status" class="se-status-value px-3 py-1 rounded-full text-sm">---</span>
                        </div>
                        <div class="se-status-row">
                            <span class="se-status-label">当前模式</span>
                            <span id="current-mode" class="se-status-value px-3 py-1 rounded-full text-sm">---</span>
                        </div>
                        <div class="se-status-row">
                            <span class="se-status-label">缓存触发数</span>
                            <span id="cached-bursts" class="se-status-value">---</span>
                        </div>
                        <div class="se-status-row">
                            <span class="se-status-label">WS 连接数</span>
                            <span id="ws-clients" class="se-status-value">---</span>
                        </div>
                    </div>
                </div>

                <!-- Operation Controls -->
                <div class="se-card">
                    <h2 class="se-card-title">操作控制</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-start" class="se-btn-primary col-span-1">启动采集</button>
                        <button id="btn-stop" class="se-btn-danger col-span-1">停止采集</button>
                        <button id="btn-continuous" class="se-btn-secondary col-span-1">连续模式</button>
                        <button id="btn-trigger" class="se-btn-secondary col-span-1">触发模式</button>
                        <button id="btn-request-data" class="se-btn-secondary col-span-2">请求触发数据</button>
                        <button id="btn-ping" class="se-btn-secondary col-span-2">Ping 设备</button>
                    </div>
                </div>

                <!-- File Management -->
                <div class="se-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="se-card-title mb-0">文件管理</h2>
                        <button id="btn-refresh-files" class="se-btn-secondary se-btn-small">刷新</button>
                    </div>
                    <ul id="file-list" class="h-48 overflow-y-auto space-y-2 pr-2">
                        <li class="text-secondary text-center p-4">加载文件中...</li>
                    </ul>
                </div>

                <!-- Logs -->
                <div class="se-card flex-grow flex flex-col">
                    <h2 class="se-card-title">日志输出</h2>
                    <div id="log-panel" class="se-log-panel flex-grow"></div>
                </div>
            </div>

            <div class="lg:col-span-3 flex flex-col gap-6">
                <!-- Real-time Data Stream -->
                <div class="se-card">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="se-card-title mb-0">实时数据流</h2>
                        <div class="flex items-center gap-4 flex-wrap">
                            <!-- Chart View Mode Toggle -->
                            <div class="se-chart-mode-toggle">
                                <button id="btn-mode-merged" class="se-chart-mode-btn active">合并视图</button>
                                <button id="btn-mode-split" class="se-chart-mode-btn">分开视图</button>
                            </div>
                            <div class="se-chart-controls">
                                <button id="btn-reset-yaxis" class="se-chart-control-btn">重置Y轴</button>
                                <button id="btn-auto-scroll" class="se-chart-control-btn">自动跟随</button>
                                <button id="btn-zoom-out" class="se-chart-control-btn">查看全部</button>
                            </div>
                            <div class="flex items-center space-x-2 bg-white/60 border border-green-200 px-3 py-2 rounded-lg">
                               <span id="ws-status-dot" class="se-status-dot se-status-disconnected-dot"></span>
                               <span id="ws-status-text" class="text-sm font-medium text-secondary">未连接</span>
                            </div>
                        </div>
                    </div>
                    <div class="se-chart-container">
                        <div id="realtimeChart" style="height: 450px;"></div>
                    </div>
                </div>
                
                <!-- Trigger Data Management -->
                <div class="se-card">
                     <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2 class="se-card-title mb-0">触发数据管理</h2>
                        <div class="flex items-center gap-3">
                            <button id="btn-save-trigger" class="se-btn-primary se-btn-small" disabled>保存选中项</button>
                            <button id="btn-refresh-triggers" class="se-btn-secondary se-btn-small">刷新列表</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 h-80 md:h-[510px] overflow-y-auto bg-white/50 p-3 rounded-lg border-2 border-green-100">
                            <h3 class="text-lg font-semibold mb-3 text-accent sticky top-0 bg-white/70 pb-2">触发批次</h3>
                            <ul id="trigger-list" class="space-y-2">
                                <li class="text-secondary text-center p-4">点击刷新获取数据</li>
                            </ul>
                        </div>
                        <div class="md:col-span-2 se-chart-container">
                             <div id="triggerPreviewChart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Save Trigger Modal -->
    <div id="save-modal" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="se-modal-content p-6 w-full max-w-md m-4">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">保存触发批次</h3>
            <div class="space-y-4">
                <div>
                    <label for="save-filename" class="block text-sm font-medium text-secondary mb-2">文件名 (不含扩展名)</label>
                    <input type="text" id="save-filename" class="w-full se-input">
                </div>
                <div>
                    <label for="save-format" class="block text-sm font-medium text-secondary mb-2">保存格式</label>
                    <select id="save-format" class="w-full se-select">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="binary">Binary</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="btn-cancel-save" class="se-btn-secondary">取消</button>
                <button id="btn-confirm-save" class="se-btn-primary">确认保存</button>
            </div>
        </div>
    </div>

<!-- JavaScript保持相同功能，只更新样式类名 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const API_BASE_URL = 'http://127.0.0.1:8080';
    const WS_URL = 'ws://127.0.0.1:8081';
    const STATUS_POLL_INTERVAL = 2000;
    const CHART_MAX_POINTS = 10000;
    const CHART_DISPLAY_POINTS = 1000;
    const DOWNSAMPLE_THRESHOLD = 2000;
    const CHANNEL_COLORS = ['#3DCD58', '#0084C7', '#FF6600', '#D93025', '#a78bfa', '#fb923c'];
    
    let ws;
    let realtimeChart;
    let splitCharts = {};
    let triggerPreviewChart;
    let channelDataArrays = {};
    let channelCount = 0;
    let sampleIndex = 0;
    let lastUpdateTime = 0;
    const UPDATE_INTERVAL = 100;
    let yAxisRange = { min: null, max: null };
    let isAutoScroll = true;
    let selectedBurstId = null;
    let chartDisplayMode = 'merged';

    const logPanel = document.getElementById('log-panel');
    const realtimeChartContainer = document.getElementById('realtimeChart');
    const deviceStatusEl = document.getElementById('device-status');
    const collectionStatusEl = document.getElementById('collection-status');
    const currentModeEl = document.getElementById('current-mode');
    const cachedBurstsEl = document.getElementById('cached-bursts');
    const wsClientsEl = document.getElementById('ws-clients');
    const wsStatusDot = document.getElementById('ws-status-dot');
    const wsStatusText = document.getElementById('ws-status-text');
    const triggerListEl = document.getElementById('trigger-list');
    const fileListEl = document.getElementById('file-list');
    const btnStart = document.getElementById('btn-start');
    const btnStop = document.getElementById('btn-stop');
    const btnRequestData = document.getElementById('btn-request-data');
    const btnSaveTrigger = document.getElementById('btn-save-trigger');
    const saveModal = document.getElementById('save-modal');

    function log(message, type = 'info') {
        const entry = document.createElement('div');
        entry.classList.add('se-log-entry', type);
        const timestamp = new Date().toLocaleTimeString('en-GB');
        entry.textContent = `[${timestamp}] ${message}`;
        logPanel.appendChild(entry);
        logPanel.scrollTop = logPanel.scrollHeight;
    }

    async function apiRequest(endpoint, method = 'GET', body = null) {
        const url = API_BASE_URL + endpoint;
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        if (body) options.body = JSON.stringify(body);
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                 const errorText = await response.text();
                 throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const data = await response.json();
                if (data.success) {
                    if (endpoint !== '/api/control/status')
                      log(`API ${method} ${endpoint}: ${typeof data.data === 'string' ? data.data : 'Success'}`, 'success');
                } else {
                    log(`API ${method} ${endpoint} FAILED: ${data.error}`, 'error');
                }
                return data;
            } else {
                return { success: true, data: 'Non-JSON response received.' };
            }
        } catch (error) {
            log(`API Request Error: ${error.message}`, 'error');
            return null;
        }
    }

    function setupChartLayout() {
        if (realtimeChart) {
            realtimeChart.dispose();
            realtimeChart = null;
        }
        Object.values(splitCharts).forEach(chart => chart.dispose());
        splitCharts = {};
        realtimeChartContainer.innerHTML = '';

        if (chartDisplayMode === 'merged') {
            realtimeChartContainer.style.height = '510px';
            realtimeChartContainer.classList.remove('split-view-container');
            initCharts();
        } else {
            realtimeChartContainer.style.height = 'auto';
            realtimeChartContainer.classList.add('split-view-container');
            if (channelCount > 0) {
                for (let i = 0; i < channelCount; i++) {
                    const div = document.createElement('div');
                    div.style.height = `${510 / channelCount}px`;
                    div.style.width = '100%';
                    realtimeChartContainer.appendChild(div);
                }
                initCharts();
            }
        }
    }

    function initCharts() {
        if (chartDisplayMode === 'merged') {
            realtimeChart = echarts.init(realtimeChartContainer);
            const option = getBaseChartOption();
            option.dataZoom = [ { type: 'inside', start: 80, end: 100 }, { type: 'slider', start: 80, end: 100, height: 25, bottom: 15, textStyle: { color: '#5F6368' } } ];
            option.legend = { textStyle: { color: '#3C4043' }, top: 5 };
            realtimeChart.setOption(option);
            realtimeChart.on('dataZoom', () => {
                if (isAutoScroll) log('手动缩放/平移已激活，自动跟随已禁用。', 'info');
                isAutoScroll = false;
                updateAutoScrollButton();
            });
        } else {
            const chartDivs = realtimeChartContainer.querySelectorAll('div');
            chartDivs.forEach((div, i) => {
                const chart = echarts.init(div);
                const option = getBaseChartOption();
                if (i === channelCount - 1) {
                    option.dataZoom = [ { type: 'inside' }, { type: 'slider', height: 20, bottom: 5 } ];
                } else {
                    option.dataZoom = [ { type: 'inside' }, { type: 'slider', show: false } ];
                }
                option.grid.bottom = (i === channelCount - 1) ? 60 : 20;
                chart.setOption(option);
                splitCharts[i] = chart;
            });
            if (Object.keys(splitCharts).length > 1) {
                echarts.connect(Object.values(splitCharts));
            }
        }

        if (!triggerPreviewChart || triggerPreviewChart.isDisposed()) {
            triggerPreviewChart = echarts.init(document.getElementById('triggerPreviewChart'));
            const option = getBaseChartOption();
            option.grid = { left: 60, right: 20, bottom: 40, top: 20, containLabel: false };
            option.title = { text: '请从左侧选择一个触发批次', left: 'center', top: '45%', textStyle: { color: '#9AA0A6' } };
            triggerPreviewChart.setOption(option);
        }
    }

    function getBaseChartOption() {
         return {
            backgroundColor: 'transparent', tooltip: { trigger: 'axis' },
            grid: { left: 60, right: 20, bottom: 80, top: 40, containLabel: false },
            xAxis: { type: 'category', boundaryGap: false, data: [], axisLabel: { color: '#5F6368' }, nameTextStyle: { color: '#5F6368' } },
            yAxis: { type: 'value', axisLabel: { color: '#5F6368' }, splitLine: { lineStyle: { color: 'rgba(189, 193, 198, 0.3)' } }, nameTextStyle: { color: '#5F6368' }, scale: true },
            series: []
        };
    }

    function updateChartSeries() {
        if (channelCount === 0) return;

        if (chartDisplayMode === 'merged') {
            const legendData = [], seriesData = [];
            let finalXAxisData;
            for (let i = 0; i < channelCount; i++) {
                legendData.push(`通道 ${i}`);
                let { data, xAxisData } = getDisplayDataForChannel(i);
                if (i === 0) finalXAxisData = xAxisData;
                seriesData.push({ name: `通道 ${i}`, type: 'line', data: data, showSymbol: false, lineStyle: { color: CHANNEL_COLORS[i % CHANNEL_COLORS.length], width: 1.5 }, animation: false });
            }
            calculateYAxisRange();
            const updateOption = { legend: { data: legendData }, xAxis: { data: finalXAxisData }, yAxis: { min: yAxisRange.min, max: yAxisRange.max }, series: seriesData };
            if (isAutoScroll) {
                const totalPoints = finalXAxisData.length;
                const newStart = Math.max(0, 100 * (totalPoints - CHART_DISPLAY_POINTS) / totalPoints);
                updateOption.dataZoom = [ { start: newStart, end: 100 }, { start: newStart, end: 100 } ];
            }
            realtimeChart.setOption(updateOption, { lazyUpdate: true });
        } else {
            Object.values(splitCharts).forEach((chart, i) => {
                const { data, xAxisData } = getDisplayDataForChannel(i);
                chart.setOption({
                    title: { text: `通道 ${i}`, left: 10, top: 0, textStyle: { color: '#3C4043', fontSize: 14 } },
                    xAxis: { data: xAxisData },
                    yAxis: { scale: true },
                    series: [{ data: data, type: 'line', showSymbol: false, lineStyle: { color: CHANNEL_COLORS[i % CHANNEL_COLORS.length], width: 1.5 }, animation: false }]
                }, { lazyUpdate: true });
            });
        }
    }
    
    function getDisplayDataForChannel(channelIndex) {
        let { data, xAxisData } = channelDataArrays[channelIndex];
        if (data.length > DOWNSAMPLE_THRESHOLD) {
            const sampled = downsampleData(data, xAxisData, CHART_DISPLAY_POINTS);
            return { data: sampled.data, xAxisData: sampled.xData };
        }
        return { data, xAxisData };
    }

    function initializeChannelData(numChannels) {
        if (channelCount === numChannels) return;
        const oldChannelCount = channelCount;
        channelCount = numChannels;
        for (let i = 0; i < numChannels; i++) {
            if (!channelDataArrays[i]) {
                channelDataArrays[i] = { data: [], xAxisData: [] };
            }
        }
        if (oldChannelCount !== numChannels) {
            setupChartLayout();
        }
        updateChartSeries();
        log(`Initialized for ${numChannels} data channels`, 'info');
    }

    function connectWebSocket() {
        ws = new WebSocket(WS_URL);
        ws.onopen = () => { 
            log('WebSocket connection established', 'ws'); 
            wsStatusDot.className = 'se-status-dot se-status-connected-dot'; 
            wsStatusText.textContent = '已连接'; 
            ws.send(JSON.stringify({ type: 'subscribe', channels: ['all'] })); 
        };
        ws.onmessage = event => {
            const msg = JSON.parse(event.data);
            if (msg.type === 'data' && msg.data && msg.channel_count > 0) {
                if (channelCount !== msg.channel_count) {
                    initializeChannelData(msg.channel_count);
                }
                const samplesPerChannel = Math.floor(msg.data.length / msg.channel_count);
                if (samplesPerChannel > 0) {
                    addDataPoint(msg.data, samplesPerChannel);
                    if (Date.now() - lastUpdateTime > UPDATE_INTERVAL) {
                        updateChartSeries();
                        lastUpdateTime = Date.now();
                    }
                }
            } else if (msg.type === 'trigger_burst_complete') {
                log(`Trigger burst complete: ${msg.burst_id}`, 'ws');
                fetchTriggerList();
            }
        };
        ws.onclose = () => { 
            log('WebSocket closed. Reconnecting in 5s...', 'error'); 
            wsStatusDot.className = 'se-status-dot se-status-disconnected-dot'; 
            wsStatusText.textContent = '已断开'; 
            setTimeout(connectWebSocket, 5000); 
        };
        ws.onerror = () => { log('WebSocket error', 'error'); ws.close(); };
    }

    async function fetchFileList() {
        const result = await apiRequest('/api/files?dir=test_output');
        fileListEl.innerHTML = '';
        if (result && result.success && Array.isArray(result.data)) {
            if (result.data.length === 0) {
                fileListEl.innerHTML = '<li class="text-secondary text-center p-4">无已存文件</li>';
                return;
            }
            result.data.forEach(file => {
                const li = document.createElement('li');
                li.className = 'se-file-item flex justify-between items-center';
                const fileSize = (file.size_bytes / 1024).toFixed(2);
                li.innerHTML = `
                    <div class="truncate pr-2">
                        <span class="text-gray-700 text-sm font-medium">${file.filename}</span>
                        <span class="text-gray-500 text-xs block">${fileSize} KB</span>
                    </div>
                    <button data-filename="${file.filename}" class="se-btn-secondary se-btn-small flex-shrink-0">下载</button>
                `;
                fileListEl.appendChild(li);
            });
            document.querySelectorAll('.se-file-item button').forEach(button => {
                button.addEventListener('click', handleDownload);
            });
        } else {
            fileListEl.innerHTML = '<li class="text-secondary text-center p-4">无法加载文件列表</li>';
        }
    }

    function handleDownload(event) {
        const filename = event.target.dataset.filename;
        if (!filename) return;

        log(`开始下载文件: ${filename}`, 'info');
        const encodedFilename = encodeURIComponent(filename);
        const url = `${API_BASE_URL}/api/files/${encodedFilename}`;
        
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', filename.split('/').pop()); 
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    async function fetchTriggerList() {
        const result = await apiRequest('/api/trigger/list');
        triggerListEl.innerHTML = '';
        selectedBurstId = null;
        btnSaveTrigger.disabled = true;

        if (result && result.success && result.data.length > 0) {
            result.data.forEach(burst => {
                const li = document.createElement('li');
                li.className = 'se-trigger-item';
                li.dataset.burstId = burst.burst_id;
                li.innerHTML = `<div class="font-semibold text-sm text-accent">${burst.burst_id.replace('trigger_', '')}</div>
                                <div class="text-xs text-secondary mt-1">样本: ${burst.total_samples} | ${burst.duration_ms.toFixed(1)}ms</div>`;
                li.onclick = () => {
                    triggerListEl.querySelectorAll('li').forEach(item => {
                        item.classList.remove('selected');
                    });
                    li.classList.add('selected');
                    
                    selectedBurstId = burst.burst_id;
                    btnSaveTrigger.disabled = false;
                    
                    previewTriggerData(burst.burst_id);
                };
                triggerListEl.appendChild(li);
            });
        } else {
            triggerListEl.innerHTML = '<li class="text-secondary text-center p-4">无可用触发数据</li>';
        }
    }

    function downsampleData(data, xData, targetPoints) {
        if (data.length <= targetPoints) {
            return { data: data, xData: xData };
        }

        const sampledData = [];
        const sampledXData = [];
        const bucketSize = data.length / targetPoints;

        for (let i = 0; i < targetPoints; i++) {
            const bucketStart = Math.floor(i * bucketSize);
            const bucketEnd = Math.floor((i + 1) * bucketSize);
            
            if (bucketStart >= data.length) break;
            
            const bucket = data.slice(bucketStart, bucketEnd);
            const xBucket = xData.slice(bucketStart, bucketEnd);
            
            if (bucket.length === 1) {
                sampledData.push(bucket[0]);
                sampledXData.push(xBucket[0]);
            } else if (bucket.length > 1) {
                const min = Math.min(...bucket);
                const max = Math.max(...bucket);
                const avg = bucket.reduce((a, b) => a + b, 0) / bucket.length;
                
                const range = max - min;
                const threshold = 0.01;
                
                if (range > threshold) {
                    const minIndex = bucket.indexOf(min);
                    const maxIndex = bucket.indexOf(max);
                    
                    if (minIndex < maxIndex) {
                        sampledData.push(min, max);
                        sampledXData.push(xBucket[minIndex], xBucket[maxIndex]);
                    } else {
                        sampledData.push(max, min);
                        sampledXData.push(xBucket[maxIndex], xBucket[minIndex]);
                    }
                } else {
                    sampledData.push(avg);
                    sampledXData.push(xBucket[Math.floor(bucket.length / 2)]);
                }
            }
        }
        return { data: sampledData, xData: sampledXData };
    }

    function calculateYAxisRange(displayData) {
        let allValues = [];
        const dataSets = displayData || Object.values(channelDataArrays).map(arr => arr.data);
        dataSets.forEach(seriesData => {
            if (seriesData && seriesData.length > 0) {
                allValues.push(...seriesData);
            }
        });
        
        if (allValues.length === 0) return;
        
        const min = Math.min(...allValues);
        const max = Math.max(...allValues);
        const range = max - min;
        
        const buffer = range > 0 ? range * 0.1 : Math.abs(max) * 0.1 || 1;
        yAxisRange.min = min - buffer;
        yAxisRange.max = max + buffer;
    }

    function addDataPoint(data, samplesPerChannel) {
        if (channelCount === 0 || !data || data.length === 0) return;
        const expectedLength = channelCount * samplesPerChannel;
        if (data.length !== expectedLength) {
            log(`Data length mismatch: expected ${expectedLength}, got ${data.length}`, 'error');
            return;
        }

        for (let ch = 0; ch < channelCount; ch++) {
            for (let s = 0; s < samplesPerChannel; s++) {
                const value = data[ch * samplesPerChannel + s];
                const globalIndex = sampleIndex + s;
                channelDataArrays[ch].data.push(value);
                channelDataArrays[ch].xAxisData.push(globalIndex);

                if (channelDataArrays[ch].data.length > CHART_MAX_POINTS) {
                    const removeCount = Math.floor(CHART_MAX_POINTS * 0.1);
                    channelDataArrays[ch].data.splice(0, removeCount);
                    channelDataArrays[ch].xAxisData.splice(0, removeCount);
                }
            }
        }
        sampleIndex += samplesPerChannel;
    }

    function updateAutoScrollButton() {
        const btn = document.getElementById('btn-auto-scroll');
        if (isAutoScroll) {
            btn.textContent = '停止跟随';
            btn.classList.remove('se-chart-control-btn');
            btn.classList.add('se-btn-secondary', 'se-btn-small');
        } else {
            btn.textContent = '自动跟随';
            btn.classList.remove('se-btn-secondary', 'se-btn-small');
            btn.classList.add('se-chart-control-btn');
        }
    }
    
    function toggleAutoScroll() {
        isAutoScroll = !isAutoScroll;
        log(`自动跟随已 ${isAutoScroll ? '启用' : '禁用'}`, 'info');
        updateAutoScrollButton();
        
        if (isAutoScroll) {
            updateChartSeries();
        }
    }

    function zoomToFullView() {
        isAutoScroll = false;
        updateAutoScrollButton();
        realtimeChart.dispatchAction({ type: 'dataZoom', start: 0, end: 100 });
        log('已切换到完整视图', 'info');
    }

    function resetYAxisRange() {
        yAxisRange = { min: null, max: null };
        calculateYAxisRange();
        realtimeChart.setOption({ yAxis: { min: yAxisRange.min, max: yAxisRange.max } });
        log('Y轴范围已重置', 'info');
    }

    function updateStatusUI(statusData) {
        function updateStatusPill(el, text, colorClass) {
            el.textContent = text;
            el.className = `se-status-value px-3 py-1 rounded-full text-sm ${colorClass}`;
        }
        
        updateStatusPill(deviceStatusEl, statusData.device_connected ? '已连接' : '未连接', 
            statusData.device_connected ? 'se-status-connected' : 'se-status-disconnected');
        updateStatusPill(collectionStatusEl, statusData.data_collection_active ? '采集中' : '已停止', 
            statusData.data_collection_active ? 'se-status-active' : 'se-status-inactive');
        updateStatusPill(currentModeEl, statusData.current_mode === 'trigger' ? '触发模式' : '连续模式', 
            statusData.current_mode === 'trigger' ? 'se-status-trigger' : 'se-status-active');
        
        cachedBurstsEl.textContent = statusData.trigger_status ? statusData.trigger_status.cached_bursts : 'N/A';
        wsClientsEl.textContent = statusData.connected_clients || 'N/A';
        
        btnStart.disabled = statusData.data_collection_active;
        btnStop.disabled = !statusData.data_collection_active;
        btnRequestData.disabled = statusData.current_mode !== 'trigger';
    }

    async function pollStatus() {
        const result = await apiRequest('/api/control/status');
        if (result && result.success) updateStatusUI(result.data);
    }

    async function previewTriggerData(burstId) {
        log(`Previewing trigger data: ${burstId}`, 'info');
        const result = await apiRequest(`/api/trigger/preview/${burstId}`);
        if (result && result.success) renderTriggerPreview(result.data);
    }

    function renderTriggerPreview(burstData) {
        if (!burstData.data_packets || burstData.data_packets.length === 0) {
             triggerPreviewChart.setOption({
                title: { text: '无数据可显示', left: 'center', top: '45%', textStyle: { color: '#9AA0A6' } }
            }, true);
            return;
        }

        const channelData = {};
        burstData.data_packets.forEach(packet => {
            const samplesPerChannel = Math.floor(packet.data.length / packet.channel_count);
            for (let ch = 0; ch < packet.channel_count; ch++) {
                if (!channelData[ch]) channelData[ch] = [];
                const start = ch * samplesPerChannel;
                const end = start + samplesPerChannel;
                channelData[ch].push(...packet.data.slice(start, end));
            }
        });

        const seriesData = Object.keys(channelData).map((chIndex, i) => ({
            name: `通道 ${chIndex}`, type: 'line', data: channelData[chIndex],
            showSymbol: false, lineStyle: { color: CHANNEL_COLORS[i % CHANNEL_COLORS.length], width: 1.5 }
        }));
        
        const xAxisData = Array.from({ length: Math.max(...Object.values(channelData).map(d => d.length)) }, (_, i) => i);
        
        triggerPreviewChart.setOption({
            title: { text: '' },
            tooltip: { trigger: 'axis' },
            legend: {
                data: Object.keys(channelData).map(ch => `通道 ${ch}`),
                textStyle: { color: '#3C4043' }, top: 0, right: 10, orient: 'horizontal'
            },
            xAxis: { type: 'category', data: xAxisData, name: '样本索引' },
            yAxis: { type: 'value', name: '数值', scale: true },
            dataZoom: [ { type: 'inside' }, { type: 'slider', height: 20, bottom: 5 } ],
            series: seriesData
        }, true);
    }

    function setupModal() {
        const btnConfirmSave = document.getElementById('btn-confirm-save');
        const btnCancelSave = document.getElementById('btn-cancel-save');
        const filenameInput = document.getElementById('save-filename');

        btnSaveTrigger.addEventListener('click', () => {
            if (!selectedBurstId) return;
            const defaultFilename = selectedBurstId.replace('trigger_', `burst_${new Date().toISOString().split('T')[0]}_`);
            filenameInput.value = defaultFilename;
            saveModal.classList.remove('hidden');
        });

        const closeModal = () => saveModal.classList.add('hidden');
        btnCancelSave.addEventListener('click', closeModal);
        saveModal.addEventListener('click', (e) => {
            if (e.target === saveModal) closeModal();
        });

        btnConfirmSave.addEventListener('click', async () => {
            const filename = filenameInput.value.trim();
            const format = document.getElementById('save-format').value;

            if (!filename) {
                log('文件名不能为空', 'error');
                return;
            }

            const saveData = {
                dir: "test_output",
                filename: filename,
                format: format,
                description: "Saved from web dashboard"
            };
            
            log(`正在保存批次 ${selectedBurstId} 为 ${filename}.${format}...`, 'info');
            const result = await apiRequest(`/api/trigger/save/${selectedBurstId}`, 'POST', saveData);
            if (result && result.success) {
                log(`文件已成功保存: ${result.data.saved_path}`, 'success');
                closeModal();
                fetchFileList();
            } else {
                log(`保存失败: ${result ? result.error : 'Unknown error'}`, 'error');
            }
        });
    }

    function setupEventListeners() {
        document.getElementById('btn-start').addEventListener('click', () => apiRequest('/api/control/start', 'POST'));
        document.getElementById('btn-stop').addEventListener('click', () => apiRequest('/api/control/stop', 'POST'));
        document.getElementById('btn-continuous').addEventListener('click', () => apiRequest('/api/control/continuous_mode', 'POST'));
        document.getElementById('btn-trigger').addEventListener('click', () => apiRequest('/api/control/trigger_mode', 'POST'));
        document.getElementById('btn-request-data').addEventListener('click', () => apiRequest('/api/control/request_trigger_data', 'POST'));
        document.getElementById('btn-ping').addEventListener('click', () => apiRequest('/api/control/ping', 'POST'));
        document.getElementById('btn-refresh-triggers').addEventListener('click', fetchTriggerList);
        document.getElementById('btn-reset-yaxis').addEventListener('click', resetYAxisRange);
        document.getElementById('btn-auto-scroll').addEventListener('click', toggleAutoScroll);
        document.getElementById('btn-zoom-out').addEventListener('click', zoomToFullView);
        document.getElementById('btn-refresh-files').addEventListener('click', fetchFileList);
        
        const btnMerged = document.getElementById('btn-mode-merged');
        const btnSplit = document.getElementById('btn-mode-split');
        btnMerged.addEventListener('click', () => {
            if (chartDisplayMode === 'merged') return;
            chartDisplayMode = 'merged';
            btnMerged.classList.add('active');
            btnSplit.classList.remove('active');
            log('切换到合并视图', 'info');
            setupChartLayout();
            updateChartSeries();
        });
        btnSplit.addEventListener('click', () => {
            if (chartDisplayMode === 'split') return;
            chartDisplayMode = 'split';
            btnSplit.classList.add('active');
            btnMerged.classList.remove('active');
            log('切换到分开视图', 'info');
            setupChartLayout();
            updateChartSeries();
        });
    }

    function init() {
        log('Initializing Schneider Electric Light Dashboard...', 'info');
        initCharts();
        setupEventListeners();
        connectWebSocket();
        pollStatus();
        setInterval(pollStatus, STATUS_POLL_INTERVAL);
        fetchTriggerList();
        updateAutoScrollButton();
        fetchFileList(); 
        setupModal(); 
    }

    init();
});
</script>

</body>
</html>
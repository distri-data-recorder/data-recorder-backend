# 数据采集系统快速测试脚本
# 用于快速验证系统基本功能

param(
    [switch]$BuildOnly,
    [switch]$TestOnly,
    [switch]$Verbose
)

$ErrorActionPreference = "Stop"

Write-Host "=== 数据采集系统快速测试 ===" -ForegroundColor Green

function Test-Environment {
    Write-Host "`n1. 检查环境..." -ForegroundColor Yellow

    # 检查GCC
    try {
        $gccVersion = & gcc --version 2>$null
        Write-Host "✓ GCC: $($gccVersion[0])" -ForegroundColor Green
    } catch {
        Write-Host "✗ GCC未安装或不在PATH中" -ForegroundColor Red
        return $false
    }

    # 检查Rust
    try {
        $env:PATH += ";$env:USERPROFILE\.cargo\bin"
        $cargoVersion = & cargo --version 2>$null
        Write-Host "✓ Rust: $cargoVersion" -ForegroundColor Green
    } catch {
        Write-Host "✗ Rust/Cargo未安装或不在PATH中" -ForegroundColor Red
        return $false
    }

    return $true
}

function Build-DataReader {
    Write-Host "`n2. 编译数据采集进程..." -ForegroundColor Yellow

    Push-Location "data-reader"
    try {
        # 清理旧文件
        Remove-Item *.o, *.exe -ErrorAction SilentlyContinue

        # 编译
        Write-Host "  编译协议模块..." -ForegroundColor Cyan
        & gcc -std=c11 -Wall -Wextra -Wno-unused-parameter -Iprotocol -O0 -g -c protocol/protocol.c -o protocol/protocol.o
        & gcc -std=c11 -Wall -Wextra -Wno-unused-parameter -Iprotocol -O0 -g -c protocol/io_buffer.c -o protocol/io_buffer.o

        Write-Host "  编译共享内存模块..." -ForegroundColor Cyan
        & gcc -std=c11 -Wall -Wextra -Wno-unused-parameter -Iprotocol -O0 -g -c shared_memory.c -o shared_memory.o

        Write-Host "  编译主程序..." -ForegroundColor Cyan
        & gcc -std=c11 -Wall -Wextra -Wno-unused-parameter -Iprotocol -O0 -g -c serialread.c -o serialread.o

        Write-Host "  链接..." -ForegroundColor Cyan
        & gcc serialread.o protocol/protocol.o protocol/io_buffer.o shared_memory.o -o serialread.exe -lkernel32 -luser32

        if (Test-Path "serialread.exe") {
            Write-Host "✓ 数据采集进程编译成功" -ForegroundColor Green
            return $true
        } else {
            Write-Host "✗ 数据采集进程编译失败" -ForegroundColor Red
            return $false
        }
    } catch {
        Write-Host "✗ 编译过程中出错: $_" -ForegroundColor Red
        return $false
    } finally {
        Pop-Location
    }
}

function Build-DataProcessor {
    Write-Host "`n3. 编译数据处理进程..." -ForegroundColor Yellow

    Push-Location "data-processor"
    try {
        Write-Host "  检查语法..." -ForegroundColor Cyan
        $checkResult = & cargo check 2>&1

        if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ Rust项目语法检查通过" -ForegroundColor Green

            Write-Host "  编译Release版本..." -ForegroundColor Cyan
            $buildResult = & cargo build --release 2>&1

            if ($LASTEXITCODE -eq 0) {
                Write-Host "✓ 数据处理进程编译成功" -ForegroundColor Green
                return $true
            } else {
                Write-Host "⚠ 编译失败，可能需要Visual Studio Build Tools" -ForegroundColor Yellow
                if ($Verbose) {
                    Write-Host "编译输出: $buildResult" -ForegroundColor Gray
                }
                return $false
            }
        } else {
            Write-Host "✗ 语法检查失败" -ForegroundColor Red
            if ($Verbose) {
                Write-Host "检查输出: $checkResult" -ForegroundColor Gray
            }
            return $false
        }
    } catch {
        Write-Host "✗ 编译过程中出错: $_" -ForegroundColor Red
        return $false
    } finally {
        Pop-Location
    }
}

function Test-DataReader {
    Write-Host "`n4. 测试数据采集进程..." -ForegroundColor Yellow

    Push-Location "data-reader"
    try {
        if (-not (Test-Path "serialread.exe")) {
            Write-Host "✗ serialread.exe不存在" -ForegroundColor Red
            return $false
        }

        # 测试帮助信息
        Write-Host "  测试帮助信息..." -ForegroundColor Cyan
        $helpResult = & .\serialread.exe --help 2>&1

        if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ 帮助信息正常显示" -ForegroundColor Green
        } else {
            Write-Host "⚠ 帮助信息显示异常" -ForegroundColor Yellow
        }

        # 测试共享内存创建（使用无效COM端口）
        Write-Host "  测试共享内存创建..." -ForegroundColor Cyan

        # 启动进程并捕获输出
        $processInfo = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo.FileName = ".\serialread.exe"
        $processInfo.Arguments = "999"
        $processInfo.RedirectStandardOutput = $true
        $processInfo.RedirectStandardError = $true
        $processInfo.UseShellExecute = $false
        $processInfo.CreateNoWindow = $true

        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $processInfo
        $process.Start() | Out-Null

        # 等待一段时间让程序初始化
        Start-Sleep -Seconds 2

        # 检查输出中是否包含共享内存初始化成功的信息
        $output = ""
        if (-not $process.HasExited) {
            # 进程仍在运行，发送退出信号
            $process.Kill()
            $output = $process.StandardOutput.ReadToEnd()
        } else {
            $output = $process.StandardOutput.ReadToEnd()
        }

        if ($output -match "Shared memory initialized successfully") {
            Write-Host "✓ 共享内存创建成功" -ForegroundColor Green
            return $true
        } else {
            Write-Host "⚠ 未检测到共享内存初始化信息" -ForegroundColor Yellow
            if ($Verbose) {
                Write-Host "程序输出: $output" -ForegroundColor Gray
            }
            return $false
        }
    } catch {
        Write-Host "✗ 测试过程中出错: $_" -ForegroundColor Red
        return $false
    } finally {
        Pop-Location
    }
}

function Test-DataProcessor {
    Write-Host "`n5. 测试数据处理进程..." -ForegroundColor Yellow

    Push-Location "data-processor"
    try {
        # 检查可执行文件是否存在
        $exePath = "target\release\data-processor.exe"
        if (-not (Test-Path $exePath)) {
            Write-Host "⚠ Release版本不存在，尝试Debug版本..." -ForegroundColor Yellow
            $exePath = "target\debug\data-processor.exe"
            if (-not (Test-Path $exePath)) {
                Write-Host "✗ 可执行文件不存在，编译可能失败" -ForegroundColor Red
                return $false
            }
        }

        Write-Host "  测试配置加载..." -ForegroundColor Cyan
        # 这里可以添加更多测试
        Write-Host "✓ 数据处理进程基本测试通过" -ForegroundColor Green
        return $true
    } catch {
        Write-Host "✗ 测试过程中出错: $_" -ForegroundColor Red
        return $false
    } finally {
        Pop-Location
    }
}

function Show-Summary {
    param($results)

    Write-Host "`n=== 测试总结 ===" -ForegroundColor Green

    $passed = 0
    $total = $results.Count

    foreach ($result in $results) {
        $status = if ($result.Success) { "✓" } else { "✗" }
        $color = if ($result.Success) { "Green" } else { "Red" }
        Write-Host "$status $($result.Name)" -ForegroundColor $color
        if ($result.Success) { $passed++ }
    }

    Write-Host "`n通过: $passed/$total" -ForegroundColor $(if ($passed -eq $total) { "Green" } else { "Yellow" })

    if ($passed -eq $total) {
        Write-Host "`n🎉 所有测试通过！系统基本功能正常。" -ForegroundColor Green
    } else {
        Write-Host "`n⚠ 部分测试失败，请查看详细信息。" -ForegroundColor Yellow
    }
}

# 主执行流程
try {
    $results = @()

    # 环境检查
    $envOk = Test-Environment
    $results += @{Name="环境检查"; Success=$envOk}

    if (-not $envOk) {
        Write-Host "`n❌ 环境检查失败，无法继续测试" -ForegroundColor Red
        exit 1
    }

    if (-not $TestOnly) {
        # 编译测试
        $readerBuild = Build-DataReader
        $results += @{Name="数据采集进程编译"; Success=$readerBuild}

        $processorBuild = Build-DataProcessor
        $results += @{Name="数据处理进程编译"; Success=$processorBuild}
    }

    if (-not $BuildOnly) {
        # 功能测试
        $readerTest = Test-DataReader
        $results += @{Name="数据采集进程测试"; Success=$readerTest}

        $processorTest = Test-DataProcessor
        $results += @{Name="数据处理进程测试"; Success=$processorTest}
    }

    # 显示总结
    Show-Summary $results

} catch {
    Write-Host "`n❌ 测试过程中发生未处理的错误: $_" -ForegroundColor Red
    exit 1
}
# æ•°æ®é‡‡é›†ç³»ç»Ÿå¿«é€Ÿæµ‹è¯•è„šæœ¬
# ç”¨äºå¿«é€ŸéªŒè¯ç³»ç»ŸåŸºæœ¬åŠŸèƒ½

param(
    [switch]$BuildOnly,
    [switch]$TestOnly,
    [switch]$Verbose
)

$ErrorActionPreference = "Stop"

Write-Host "=== æ•°æ®é‡‡é›†ç³»ç»Ÿå¿«é€Ÿæµ‹è¯• ===" -ForegroundColor Green

function Test-Environment {
    Write-Host "`n1. æ£€æŸ¥ç¯å¢ƒ..." -ForegroundColor Yellow

    # æ£€æŸ¥GCC
    try {
        $gccVersion = & gcc --version 2>$null
        Write-Host "âœ“ GCC: $($gccVersion[0])" -ForegroundColor Green
    } catch {
        Write-Host "âœ— GCCæœªå®‰è£…æˆ–ä¸åœ¨PATHä¸­" -ForegroundColor Red
        return $false
    }

    # æ£€æŸ¥Rust
    try {
        $env:PATH += ";$env:USERPROFILE\.cargo\bin"
        $cargoVersion = & cargo --version 2>$null
        Write-Host "âœ“ Rust: $cargoVersion" -ForegroundColor Green
    } catch {
        Write-Host "âœ— Rust/Cargoæœªå®‰è£…æˆ–ä¸åœ¨PATHä¸­" -ForegroundColor Red
        return $false
    }

    return $true
}

function Build-DataReader {
    Write-Host "`n2. ç¼–è¯‘æ•°æ®é‡‡é›†è¿›ç¨‹..." -ForegroundColor Yellow

    Push-Location "data-reader"
    try {
        # æ¸…ç†æ—§æ–‡ä»¶
        Remove-Item *.o, *.exe -ErrorAction SilentlyContinue

        # ç¼–è¯‘
        Write-Host "  ç¼–è¯‘åè®®æ¨¡å—..." -ForegroundColor Cyan
        & gcc -std=c11 -Wall -Wextra -Wno-unused-parameter -Iprotocol -O0 -g -c protocol/protocol.c -o protocol/protocol.o
        & gcc -std=c11 -Wall -Wextra -Wno-unused-parameter -Iprotocol -O0 -g -c protocol/io_buffer.c -o protocol/io_buffer.o

        Write-Host "  ç¼–è¯‘å…±äº«å†…å­˜æ¨¡å—..." -ForegroundColor Cyan
        & gcc -std=c11 -Wall -Wextra -Wno-unused-parameter -Iprotocol -O0 -g -c shared_memory.c -o shared_memory.o

        Write-Host "  ç¼–è¯‘ä¸»ç¨‹åº..." -ForegroundColor Cyan
        & gcc -std=c11 -Wall -Wextra -Wno-unused-parameter -Iprotocol -O0 -g -c serialread.c -o serialread.o

        Write-Host "  é“¾æ¥..." -ForegroundColor Cyan
        & gcc serialread.o protocol/protocol.o protocol/io_buffer.o shared_memory.o -o serialread.exe -lkernel32 -luser32

        if (Test-Path "serialread.exe") {
            Write-Host "âœ“ æ•°æ®é‡‡é›†è¿›ç¨‹ç¼–è¯‘æˆåŠŸ" -ForegroundColor Green
            return $true
        } else {
            Write-Host "âœ— æ•°æ®é‡‡é›†è¿›ç¨‹ç¼–è¯‘å¤±è´¥" -ForegroundColor Red
            return $false
        }
    } catch {
        Write-Host "âœ— ç¼–è¯‘è¿‡ç¨‹ä¸­å‡ºé”™: $_" -ForegroundColor Red
        return $false
    } finally {
        Pop-Location
    }
}

function Build-DataProcessor {
    Write-Host "`n3. ç¼–è¯‘æ•°æ®å¤„ç†è¿›ç¨‹..." -ForegroundColor Yellow

    Push-Location "data-processor"
    try {
        Write-Host "  æ£€æŸ¥è¯­æ³•..." -ForegroundColor Cyan
        $checkResult = & cargo check 2>&1

        if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ“ Rusté¡¹ç›®è¯­æ³•æ£€æŸ¥é€šè¿‡" -ForegroundColor Green

            Write-Host "  ç¼–è¯‘Releaseç‰ˆæœ¬..." -ForegroundColor Cyan
            $buildResult = & cargo build --release 2>&1

            if ($LASTEXITCODE -eq 0) {
                Write-Host "âœ“ æ•°æ®å¤„ç†è¿›ç¨‹ç¼–è¯‘æˆåŠŸ" -ForegroundColor Green
                return $true
            } else {
                Write-Host "âš  ç¼–è¯‘å¤±è´¥ï¼Œå¯èƒ½éœ€è¦Visual Studio Build Tools" -ForegroundColor Yellow
                if ($Verbose) {
                    Write-Host "ç¼–è¯‘è¾“å‡º: $buildResult" -ForegroundColor Gray
                }
                return $false
            }
        } else {
            Write-Host "âœ— è¯­æ³•æ£€æŸ¥å¤±è´¥" -ForegroundColor Red
            if ($Verbose) {
                Write-Host "æ£€æŸ¥è¾“å‡º: $checkResult" -ForegroundColor Gray
            }
            return $false
        }
    } catch {
        Write-Host "âœ— ç¼–è¯‘è¿‡ç¨‹ä¸­å‡ºé”™: $_" -ForegroundColor Red
        return $false
    } finally {
        Pop-Location
    }
}

function Test-DataReader {
    Write-Host "`n4. æµ‹è¯•æ•°æ®é‡‡é›†è¿›ç¨‹..." -ForegroundColor Yellow

    Push-Location "data-reader"
    try {
        if (-not (Test-Path "serialread.exe")) {
            Write-Host "âœ— serialread.exeä¸å­˜åœ¨" -ForegroundColor Red
            return $false
        }

        # æµ‹è¯•å¸®åŠ©ä¿¡æ¯
        Write-Host "  æµ‹è¯•å¸®åŠ©ä¿¡æ¯..." -ForegroundColor Cyan
        $helpResult = & .\serialread.exe --help 2>&1

        if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ“ å¸®åŠ©ä¿¡æ¯æ­£å¸¸æ˜¾ç¤º" -ForegroundColor Green
        } else {
            Write-Host "âš  å¸®åŠ©ä¿¡æ¯æ˜¾ç¤ºå¼‚å¸¸" -ForegroundColor Yellow
        }

        # æµ‹è¯•å…±äº«å†…å­˜åˆ›å»ºï¼ˆä½¿ç”¨æ— æ•ˆCOMç«¯å£ï¼‰
        Write-Host "  æµ‹è¯•å…±äº«å†…å­˜åˆ›å»º..." -ForegroundColor Cyan

        # å¯åŠ¨è¿›ç¨‹å¹¶æ•è·è¾“å‡º
        $processInfo = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo.FileName = ".\serialread.exe"
        $processInfo.Arguments = "999"
        $processInfo.RedirectStandardOutput = $true
        $processInfo.RedirectStandardError = $true
        $processInfo.UseShellExecute = $false
        $processInfo.CreateNoWindow = $true

        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $processInfo
        $process.Start() | Out-Null

        # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©ç¨‹åºåˆå§‹åŒ–
        Start-Sleep -Seconds 2

        # æ£€æŸ¥è¾“å‡ºä¸­æ˜¯å¦åŒ…å«å…±äº«å†…å­˜åˆå§‹åŒ–æˆåŠŸçš„ä¿¡æ¯
        $output = ""
        if (-not $process.HasExited) {
            # è¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œå‘é€é€€å‡ºä¿¡å·
            $process.Kill()
            $output = $process.StandardOutput.ReadToEnd()
        } else {
            $output = $process.StandardOutput.ReadToEnd()
        }

        if ($output -match "Shared memory initialized successfully") {
            Write-Host "âœ“ å…±äº«å†…å­˜åˆ›å»ºæˆåŠŸ" -ForegroundColor Green
            return $true
        } else {
            Write-Host "âš  æœªæ£€æµ‹åˆ°å…±äº«å†…å­˜åˆå§‹åŒ–ä¿¡æ¯" -ForegroundColor Yellow
            if ($Verbose) {
                Write-Host "ç¨‹åºè¾“å‡º: $output" -ForegroundColor Gray
            }
            return $false
        }
    } catch {
        Write-Host "âœ— æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: $_" -ForegroundColor Red
        return $false
    } finally {
        Pop-Location
    }
}

function Test-DataProcessor {
    Write-Host "`n5. æµ‹è¯•æ•°æ®å¤„ç†è¿›ç¨‹..." -ForegroundColor Yellow

    Push-Location "data-processor"
    try {
        # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        $exePath = "target\release\data-processor.exe"
        if (-not (Test-Path $exePath)) {
            Write-Host "âš  Releaseç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œå°è¯•Debugç‰ˆæœ¬..." -ForegroundColor Yellow
            $exePath = "target\debug\data-processor.exe"
            if (-not (Test-Path $exePath)) {
                Write-Host "âœ— å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥" -ForegroundColor Red
                return $false
            }
        }

        Write-Host "  æµ‹è¯•é…ç½®åŠ è½½..." -ForegroundColor Cyan
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šæµ‹è¯•
        Write-Host "âœ“ æ•°æ®å¤„ç†è¿›ç¨‹åŸºæœ¬æµ‹è¯•é€šè¿‡" -ForegroundColor Green
        return $true
    } catch {
        Write-Host "âœ— æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: $_" -ForegroundColor Red
        return $false
    } finally {
        Pop-Location
    }
}

function Show-Summary {
    param($results)

    Write-Host "`n=== æµ‹è¯•æ€»ç»“ ===" -ForegroundColor Green

    $passed = 0
    $total = $results.Count

    foreach ($result in $results) {
        $status = if ($result.Success) { "âœ“" } else { "âœ—" }
        $color = if ($result.Success) { "Green" } else { "Red" }
        Write-Host "$status $($result.Name)" -ForegroundColor $color
        if ($result.Success) { $passed++ }
    }

    Write-Host "`né€šè¿‡: $passed/$total" -ForegroundColor $(if ($passed -eq $total) { "Green" } else { "Yellow" })

    if ($passed -eq $total) {
        Write-Host "`nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»ŸåŸºæœ¬åŠŸèƒ½æ­£å¸¸ã€‚" -ForegroundColor Green
    } else {
        Write-Host "`nâš  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚" -ForegroundColor Yellow
    }
}

# ä¸»æ‰§è¡Œæµç¨‹
try {
    $results = @()

    # ç¯å¢ƒæ£€æŸ¥
    $envOk = Test-Environment
    $results += @{Name="ç¯å¢ƒæ£€æŸ¥"; Success=$envOk}

    if (-not $envOk) {
        Write-Host "`nâŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥ï¼Œæ— æ³•ç»§ç»­æµ‹è¯•" -ForegroundColor Red
        exit 1
    }

    if (-not $TestOnly) {
        # ç¼–è¯‘æµ‹è¯•
        $readerBuild = Build-DataReader
        $results += @{Name="æ•°æ®é‡‡é›†è¿›ç¨‹ç¼–è¯‘"; Success=$readerBuild}

        $processorBuild = Build-DataProcessor
        $results += @{Name="æ•°æ®å¤„ç†è¿›ç¨‹ç¼–è¯‘"; Success=$processorBuild}
    }

    if (-not $BuildOnly) {
        # åŠŸèƒ½æµ‹è¯•
        $readerTest = Test-DataReader
        $results += @{Name="æ•°æ®é‡‡é›†è¿›ç¨‹æµ‹è¯•"; Success=$readerTest}

        $processorTest = Test-DataProcessor
        $results += @{Name="æ•°æ®å¤„ç†è¿›ç¨‹æµ‹è¯•"; Success=$processorTest}
    }

    # æ˜¾ç¤ºæ€»ç»“
    Show-Summary $results

} catch {
    Write-Host "`nâŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿæœªå¤„ç†çš„é”™è¯¯: $_" -ForegroundColor Red
    exit 1
}